<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ë³´ê³ ì„œ ëª©ë¡</title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/footer.css" />
    <link rel="stylesheet" href="css/report-list.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div id="header-container"></div>

    <div class="container">
      <h2>ğŸ“‘ ì „ì²´ë³´ê¸°</h2>
      <table class="report-table" id="reportTable">
        <thead>
          <tr>
            <th width="45%">ë‚ ì§œ</th>
            <th width="35%">ì‚¬ìš©ì</th>
            <th width="20%" style="text-align: center">ì—´ê¸°</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="3" class="empty-msg">ë°ì´í„° ë¡œë”© ì¤‘...</td>
          </tr>
        </tbody>
      </table>
      <div
        id="pagination"
        style="
          margin-top: 10px;
          display: flex;
          justify-content: center;
          gap: 10px;
        "
      >
        <button id="prevPage" disabled>â—€</button>
        <span id="pageInfo">1 / 1</span>
        <button id="nextPage" disabled>â–¶</button>
      </div>
    </div>

    <div id="reportModal" class="modal-overlay">
      <div class="modal-window">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">ğŸ“„ ë³´ê³ ì„œ ìƒì„¸ ë‚´ìš©</div>
          <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body markdown-body" id="modalContent"></div>
      </div>
    </div>

    <div id="footer-container"></div>

    <script src="js/config.js"></script>
    <script src="js/header.js"></script>
    <script src="js/footer.js"></script>
    <script>
      // ë‚ ì§œ í˜•ì‹ ë³€í™˜
      function formatDateTime(isoString) {
        if (!isoString) return { date: "-", time: "" };
        try {
          const dateObj = new Date(isoString);
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, "0");
          const day = String(dateObj.getDate()).padStart(2, "0");
          const hours = String(dateObj.getHours()).padStart(2, "0");
          const minutes = String(dateObj.getMinutes()).padStart(2, "0");
          return {
            date: `${year}. ${month}. ${day}.`,
            time: `${hours}:${minutes}`,
          };
        } catch (e) {
          return { date: isoString, time: "" };
        }
      }

      // í˜ì´ì§€ë„¤ì´ì…˜ ë³€ìˆ˜
      let currentPage = 1;
      const pageSize = 10;
      let allReports = [];

      async function loadReports() {
        const tbody = document.querySelector("#reportTable tbody");
        try {
          const res = await fetch(
            `${window.API_BASE_URL}/api/user/report/list`,
            {
              credentials: "include",
            }
          );
          if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");

          const reports = await res.json();
          allReports = reports.sort((a, b) => new Date(b.SK) - new Date(a.SK)); // ìµœì‹ ìˆœ ì •ë ¬

          tbody.innerHTML = "";

          if (!allReports || allReports.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">ì €ì¥ëœ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            document.getElementById("prevPage").disabled = true;
            document.getElementById("nextPage").disabled = true;
            document.getElementById("pageInfo").textContent = "0 / 0";
            return;
          }

          renderPage();
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="3" class="empty-msg" style="color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
        }
      }

      function renderPage() {
        const tbody = document.querySelector("#reportTable tbody");
        tbody.innerHTML = "";

        const totalPages = Math.ceil(allReports.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageReports = allReports.slice(start, end);

        pageReports.forEach((report) => {
          const tr = document.createElement("tr");
          const dt = formatDateTime(report.SK);

          tr.innerHTML = `
                <td>
                    <span class="date-main">ğŸ“… ${dt.date}</span>
                    <span class="date-sub">${dt.time}</span>
                </td>
                <td>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="background:#eee; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold; color:#555;">User</span>
                        <b style="font-size:15px;">${report.User}</b>
                    </div>
                </td>
                <td style="text-align: center;">
                    <span class="arrow-icon">â€º</span>
                </td>
            `;
          tbody.appendChild(tr);

          tr.addEventListener("click", () => {
            openModal(report);
          });
        });

        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
          currentPage === totalPages;
        document.getElementById(
          "pageInfo"
        ).textContent = `${currentPage} / ${totalPages}`;
      }

      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      });
      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(allReports.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderPage();
        }
      });

      function openModal(report) {
        const modal = document.getElementById("reportModal");
        const contentDiv = document.getElementById("modalContent");
        const titleDiv = document.getElementById("modalTitle");

        modal.style.display = "flex";

        const dt = formatDateTime(report.SK);
        titleDiv.innerHTML = `ğŸ“„ <b>${dt.date} ${dt.time}</b> ë³´ê³ ì„œ`;

        let rawContent = report.Content || report.content;

        if (!rawContent) {
          contentDiv.innerHTML =
            '<p style="color:#888; text-align:center;">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          contentDiv.innerHTML = marked.parse(rawContent);
        }
      }

      function closeModal() {
        document.getElementById("reportModal").style.display = "none";
      }

      window.onclick = function (event) {
        const modal = document.getElementById("reportModal");
        if (event.target == modal) {
          closeModal();
        }
      };

      document.addEventListener("DOMContentLoaded", loadReports);
    </script>
    <script src="js/header.js"></script>
    <script src="js/footer.js"></script>
  </body>
</html>
