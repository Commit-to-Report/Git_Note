<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitNote 보고서</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
        h1 { color: #333; }
        pre {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 300px;
            font-family: monospace;
        }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
        #status { margin-bottom: 10px; }
        .style-buttons { margin-top: 10px; }
    </style>
</head>
<body>
<h1>GitNote 보고서</h1>
<p id="status">보고서를 준비 중입니다...</p>

<!-- 수정 가능한 pre -->
<pre id="summary" contenteditable="false"></pre>
<button id="editBtn" disabled>수정 가능</button>
<button id="saveBtn" disabled>보고서 저장</button>

<div class="style-buttons">
    <button id="styleSummaryBtn">간결 요약</button>
    <button id="styleDetailedBtn">상세 분석</button>
    <button id="styleStatisticsBtn">통계 중심</button>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const s3Url = urlParams.get("s3Url"); // report.html?s3Url=전체S3주소
    const statusEl = document.getElementById("status");
    const summary = document.getElementById("summary");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");

    const s3Key = s3Url ? decodeURIComponent(s3Url.split(".com/")[1]) : null;
    console.log("s3Key:", s3Key);

    async function generateReport(style) {
        if (!s3Key) {
            statusEl.textContent = "S3 키를 추출할 수 없습니다.";
            return;
        }

        statusEl.textContent = "서버에서 S3 파일을 불러와 보고서를 생성 중입니다...";
        summary.textContent = "";
        summary.contentEditable = "false";
        editBtn.disabled = true;
        saveBtn.disabled = true;

        try {
            const res = await fetch(`http://localhost:8080/api/s3/report?key=${encodeURIComponent(s3Key)}&style=${style}`);
            const text = await res.text();

            try {
                const data = JSON.parse(text);
                if (res.ok) {
                    summary.textContent = data.summary;
                    editBtn.disabled = false;
                    saveBtn.disabled = false;
                    statusEl.textContent = `보고서 생성 완료! (${style})`;
                } else {
                    summary.textContent = data.error || "알 수 없는 오류가 발생했습니다.";
                    statusEl.textContent = `보고서 생성 실패! (${style})`;
                }
            } catch (e) {
                summary.textContent = "서버 응답이 JSON이 아닙니다:\n" + text;
                statusEl.textContent = `보고서 생성 실패! (${style})`;
            }

        } catch (err) {
            summary.textContent = "요청 실패: " + err.message;
            statusEl.textContent = `보고서 생성 실패! (${style})`;
        }
    }

    // 수정 버튼 클릭 시 편집 가능하게 처리
    editBtn.addEventListener("click", () => {
        summary.contentEditable = "true";
        summary.focus();
    });

    // 저장 버튼 클릭 시 DDB 저장
    saveBtn.addEventListener("click", async () => {
        const updatedReport = summary.textContent;
        const reportId = s3Key;
        const userId = "exampleUserId";

        try {
            const res = await fetch("http://localhost:8080/api/user/report", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userId, reportId, content: updatedReport })
            });
            const data = await res.json();
            if(res.ok) {
                alert("보고서 저장 완료!");
            } else {
                alert("저장 실패: " + data.message);
            }
        } catch(err) {
            alert("저장 중 오류 발생: " + err.message);
        }
    });

    // 스타일 버튼 이벤트 바인딩
    document.getElementById("styleSummaryBtn").addEventListener("click", () => generateReport("summary"));
    document.getElementById("styleDetailedBtn").addEventListener("click", () => generateReport("detailed"));
    document.getElementById("styleStatisticsBtn").addEventListener("click", () => generateReport("statistics"));

    // 초기 로딩 시 기본 간결 요약 생성
    generateReport("summary");
</script>
</body>
</html>
