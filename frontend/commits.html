<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitNote - 커밋 조회</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#f5f5f5; min-height:100vh; padding:20px; }
    .container { max-width:900px; margin:20px auto; background:white; border:1px solid #ddd; border-radius:8px; padding:30px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    h1 { color:#333; margin-bottom:20px; font-size:24px; text-align:center; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #ddd; }
    .user-info { display:flex; align-items:center; gap:10px; font-size:14px; color:#666; }
    .user-info img { width:32px; height:32px; border-radius:50%; }
    .user-info .username { font-weight:500; color:#333; }
    .btn-logout { padding:8px 16px; background:#d73a49; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; transition:background-color 0.2s; }
    .btn-logout:hover { background:#b52a3a; }
    .filter-section { background:#f9f9f9; padding:20px; border-radius:6px; margin-bottom:20px; border:1px solid #e1e4e8; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
    .form-group { display:flex; flex-direction:column; }
    .form-group.full-width { grid-column:1 / -1; }
    label { margin-bottom:6px; color:#333; font-weight:500; font-size:14px; }
    select,input[type="date"] { padding:8px 12px; border:1px solid #d1d5da; border-radius:6px; font-size:14px; transition:border-color 0.2s; background:white; }
    select:disabled,input[type="date"]:disabled { cursor:not-allowed; background:#f6f8fa; opacity:0.6; }
    select:focus,input[type="date"]:focus { outline:none; border-color:#0366d6; }
    select:hover:not(:disabled),input[type="date"]:hover:not(:disabled) { border-color:#0366d6; }
    .button-group { display:flex; gap:10px; margin-top:15px; }
    .btn { padding:8px 16px; border:none; border-radius:6px; font-size:14px; cursor:pointer; transition:background-color 0.2s; }
    .btn-primary { background:#24292e; color:white; }
    .btn-primary:hover { background:#444; }
    .btn-primary:disabled { background:#ccc; cursor:not-allowed; }
    .btn-success { background:#28a745; color:white; }
    .btn-success:hover { background:#218838; }
    .btn-success:disabled { background:#ccc; cursor:not-allowed; }
    .loading { text-align:center; padding:40px; color:#666; font-size:14px; }
    .loading::after { content:"..."; animation:dots 1.5s steps(4,end) infinite; }
    @keyframes dots { 0%,20% { content:"."; } 40% { content:".."; } 60%,100% { content:"..."; } }
    .error-message { background:#fff5f5; color:#d73a49; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #fdd; font-size:14px; }
    .success-message { background:#f0fff4; color:#28a745; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #c6f6d5; font-size:14px; }
    .info-message { background:#f0f8ff; color:#0366d6; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #bee5eb; font-size:14px; }
    .commits-section { margin-top:20px; }
    .commits-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .commits-header h2 { color:#333; font-size:18px; font-weight:500; }
    .commit-count { background:#f6f8fa; color:#333; padding:4px 10px; border-radius:12px; font-size:13px; border:1px solid #e1e4e8; }
    .empty-state { text-align:center; padding:40px 20px; color:#666; }
    .empty-state-icon { font-size:48px; margin-bottom:15px; }
    .empty-state h3 { color:#333; margin-bottom:8px; font-size:16px; }
    .empty-state p { color:#666; font-size:14px; }
    @media (max-width:768px) {
      body { padding:10px; }
      .container { padding:20px; }
      .form-row { grid-template-columns:1fr; }
      .header { flex-direction:column; gap:10px; align-items:flex-start; }
      h1 { font-size:20px; }
      .button-group { flex-direction:column; width:100%; }
      .btn { width:100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>GitNote - 커밋 조회</h1>
    <div class="user-info">
      <img id="userAvatar" src="" alt="User" />
      <span class="username" id="username"></span>
      <button class="btn-logout" onclick="logout()">로그아웃</button>
    </div>
  </div>

  <div id="messageBox"></div>

  <!-- 필터 섹션 -->
  <div class="filter-section">
    <div class="form-row">
      <div class="form-group full-width">
        <label for="repositorySelect">리포지토리</label>
        <select id="repositorySelect">
          <option value="">리포지토리를 불러오는 중...</option>
        </select>
        <div id="selectedRepoInfo" style="margin-top:8px; font-size:12px; color:#666"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="sinceDate">시작 날짜</label>
        <input type="date" id="sinceDate" />
      </div>
      <div class="form-group">
        <label for="untilDate">종료 날짜</label>
        <input type="date" id="untilDate" />
      </div>
    </div>
    <div class="button-group">
      <button class="btn btn-primary" id="searchBtn" onclick="searchCommits()">커밋 조회</button>
      <button class="btn btn-success" id="copyBtn" onclick="copyCommitsText()" disabled style="display:none">텍스트 복사</button>
      <button class="btn btn-primary" id="summaryBtn" onclick="requestCommitSummary()" disabled style="display:none; background:#6f42c1">재미나이 요약 요청</button>
    </div>
  </div>

  <!-- 로딩 및 결과 섹션 -->
  <div id="loadingBox" style="display:none">
    <div class="loading">커밋을 불러오는 중</div>
  </div>

  <div id="commitsSection" style="display:none">
    <div class="commits-header">
      <h2>커밋 목록</h2>
      <span class="commit-count" id="commitCount">0개</span>
    </div>
    <div id="commitsList"></div>
  </div>

  <div id="emptyState" style="display:none">
    <div class="empty-state">
      <div class="empty-state-icon">-</div>
      <h3>커밋이 없습니다</h3>
      <p>선택한 기간에 커밋이 없거나 다른 조건을 시도해보세요.</p>
    </div>
  </div>
</div>

<script>
  const API_BASE = "http://localhost:8080";
  let currentCommits = [];
  let selectedRepo = null;
  let currentCommitsText = "";

  async function init() {
    const username = sessionStorage.getItem("username");
    const avatar = sessionStorage.getItem("avatar");

    if (!username) {
      showMessage("⚠️ 로그인이 필요합니다.", "error");
      setTimeout(() => { sessionStorage.clear(); window.location.href = "index.html"; }, 2000);
      return;
    }

    document.getElementById("username").textContent = username;
    document.getElementById("userAvatar").src = avatar || "https://via.placeholder.com/50";

    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(today.getDate() - 7);
    document.getElementById("untilDate").value = today.toISOString().split("T")[0];
    document.getElementById("sinceDate").value = weekAgo.toISOString().split("T")[0];

    await loadRepositories();
  }

  async function loadRepositories() {
    const select = document.getElementById("repositorySelect");
    select.innerHTML = '<option value="">리포지토리를 불러오는 중...</option>';
    select.disabled = true;

    try {
      const response = await fetch(`${API_BASE}/api/github/repositories`, { method:"GET", credentials:"include", headers:{Accept:"application/json"} });
      if (!response.ok) throw new Error("리포지토리를 불러오는데 실패했습니다.");
      const data = await response.json();
      select.innerHTML = '<option value="">리포지토리를 선택하세요</option>';
      if (data.repositories?.length) {
        data.repositories.forEach(repo => {
          const fullName = repo.fullName || repo.full_name;
          const option = document.createElement("option");
          option.value = JSON.stringify({ owner: repo.owner || fullName.split("/")[0], name: repo.name, fullName });
          option.textContent = fullName + (repo.private ? " (Private)" : "");
          select.appendChild(option);
        });
      } else {
        select.innerHTML = '<option value="">리포지토리가 없습니다</option>';
      }
      select.disabled = false;
      select.addEventListener("change", function() {
        const selectedRepoInfo = document.getElementById("selectedRepoInfo");
        if (this.value) {
          try {
            const repoData = JSON.parse(this.value);
            selectedRepoInfo.innerHTML = `선택됨: <strong>${repoData.fullName}</strong>`;
            selectedRepoInfo.style.color = "#28a745";
          } catch { selectedRepoInfo.innerHTML="선택 오류"; selectedRepoInfo.style.color="#d73a49"; }
        } else { selectedRepoInfo.innerHTML=""; }
      });
    } catch (error) {
      showMessage("❌ " + error.message, "error");
      select.innerHTML = '<option value="">불러오기 실패</option>';
      select.disabled = false;
    }
  }

  async function searchCommits() {
    const repoSelect = document.getElementById("repositorySelect");
    const since = document.getElementById("sinceDate").value;
    const until = document.getElementById("untilDate").value;
    if (!repoSelect.value) { showMessage("⚠️ 리포지토리를 선택해주세요.", "error"); return; }
    if (!since || !until) { showMessage("⚠️ 날짜를 선택해주세요.", "error"); return; }

    selectedRepo = JSON.parse(repoSelect.value);
    document.getElementById("loadingBox").style.display = "block";
    document.getElementById("commitsSection").style.display = "none";
    document.getElementById("emptyState").style.display = "none";
    document.getElementById("searchBtn").disabled = true;
    document.getElementById("copyBtn").disabled = true;
    document.getElementById("copyBtn").style.display = "none";
    document.getElementById("summaryBtn").disabled = true;
    document.getElementById("summaryBtn").style.display = "none";

    try {
      const url = `${API_BASE}/api/github/commits?owner=${encodeURIComponent(selectedRepo.owner)}&repo=${encodeURIComponent(selectedRepo.name)}&since=${since}&until=${until}&includeDetails=false`;
      const response = await fetch(url, { credentials:"include" });
      if (!response.ok) throw new Error("커밋을 불러올 수 없습니다.");
      const data = await response.json();
      currentCommits = data.commits;
      displayCommits(data.commits);
    } catch (error) { showMessage(error.message, "error"); }
    finally { document.getElementById("loadingBox").style.display="none"; document.getElementById("searchBtn").disabled=false; }
  }

  function displayCommits(commits) {
    if (!commits.length) { document.getElementById("emptyState").style.display="block"; document.getElementById("copyBtn").style.display="none"; document.getElementById("summaryBtn").style.display="none"; return; }

    document.getElementById("commitsSection").style.display="block";
    document.getElementById("commitCount").textContent=`${commits.length}개`;

    let textContent=`리포지토리: ${selectedRepo?.fullName || "Unknown"}\n조회 기간: ${document.getElementById("sinceDate").value} ~ ${document.getElementById("untilDate").value}\n총 커밋 수: ${commits.length}\n${"=".repeat(80)}\n\n`;

    commits.forEach((commit,index)=>{
      const message = commit.commit?.message || "No message";
      const authorName = commit.commit?.author?.name || "Unknown";
      const authorEmail = commit.commit?.author?.email || "";
      const authorDate = commit.commit?.author?.date || "";
      const sha = commit.sha || "";
      const url = commit.htmlUrl || commit.html_url || "";
      const date = authorDate ? new Date(authorDate).toISOString() : "";
      textContent += `[${index+1}] ${sha.substring(0,7)}\n메시지: ${message}\n작성자: ${authorName}${authorEmail? " <"+authorEmail+">":""}\n날짜: ${date}\nURL: ${url}\n${"=".repeat(80)}\n\n`;
    });

    currentCommitsText=textContent;
    document.getElementById("commitsList").innerHTML=`<pre style="white-space:pre-wrap; word-wrap:break-word; background:#f8f9fa; padding:20px; border-radius:8px; font-family:'Courier New',monospace; font-size:13px; line-height:1.6; color:#333; max-height:600px; overflow-y:auto;">${escapeHtml(textContent)}</pre>`;
    document.getElementById("copyBtn").style.display="inline-block";
    document.getElementById("copyBtn").disabled=false;
    document.getElementById("summaryBtn").style.display="inline-block";
    document.getElementById("summaryBtn").disabled=false;
  }

  async function copyCommitsText() {
    if (!currentCommitsText) { showMessage("복사할 커밋 데이터가 없습니다.", "error"); return; }
    try { await navigator.clipboard.writeText(currentCommitsText); showMessage("✅ 클립보드에 복사되었습니다!", "success"); } catch (error) { showMessage("❌ 복사 실패: "+error.message, "error"); }
  }

  async function requestCommitSummary() {
    if (!currentCommitsText || !selectedRepo) { showMessage("⚠️ 요약할 커밋이 없습니다.", "error"); return; }

    const summaryBtn=document.getElementById("summaryBtn");
    summaryBtn.disabled=true; summaryBtn.textContent="요약 요청 중...";

    try {
      const response = await fetch(`${API_BASE}/api/summary/commits`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", // 세션 쿠키 전달
        body: JSON.stringify({
          owner: selectedRepo.owner,
          repo: selectedRepo.name,
          since: document.getElementById("sinceDate").value,
          until: document.getElementById("untilDate").value
        })
      });

      if(!response.ok){ const errText=await response.text(); throw new Error(errText || "요약 요청 실패"); }
      const summary = await response.text();
      showMessage("✅ 요약 완료! 아래에서 확인 가능합니다.", "success");
      document.getElementById("commitsList").innerHTML=`<pre style="white-space:pre-wrap; word-wrap:break-word; background:#f8f9fa; padding:20px; border-radius:8px; font-family:'Courier New',monospace; font-size:13px; line-height:1.6; color:#333; max-height:600px; overflow-y:auto;">${escapeHtml(summary)}</pre>`;
    } catch(error){ showMessage("❌ 요약 요청 실패: "+error.message,"error"); }
    finally{ summaryBtn.disabled=false; summaryBtn.textContent="재미나이 요약 요청"; }
  }

  async function logout(){ try{ await fetch(`${API_BASE}/api/logout`,{method:"POST",credentials:"include"}); sessionStorage.clear(); window.location.href="index.html"; }catch{ sessionStorage.clear(); window.location.href="index.html"; } }

  function showMessage(message,type){ const box=document.getElementById("messageBox"); let className=""; if(type==="error") className="error-message"; else if(type==="success") className="success-message"; else className="info-message"; box.innerHTML=`<div class="${className}">${message}</div>`; setTimeout(()=>{ box.innerHTML=""; },5000); }

  function escapeHtml(text){ return text.replace(/[&<>"']/g,function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]; }); }

  window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
