<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ì¡°íšŒ</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            Oxygen, Ubuntu, Cantarell, sans-serif;
          background-color: #f5f5f5;
          min-height: 100vh;
          padding: 20px;
        }

        .container {
          max-width: 900px;
          margin: 20px auto;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 30px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
          color: #333;
          margin-bottom: 20px;
          font-size: 24px;
          text-align: center;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 20px;
          border-bottom: 1px solid #ddd;
        }

        .user-info {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 14px;
          color: #666;
        }

        .user-info img {
          width: 32px;
          height: 32px;
          border-radius: 50%;
        }

        .user-info .username {
          font-weight: 500;
          color: #333;
        }

        .btn-logout {
          padding: 8px 16px;
          background: #d73a49;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: background-color 0.2s;
        }

        .btn-logout:hover {
          background: #b52a3a;
        }

        .filter-section {
          background: #f9f9f9;
          padding: 20px;
          border-radius: 6px;
          margin-bottom: 20px;
          border: 1px solid #e1e4e8;
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 15px;
        }

        .form-group {
          display: flex;
          flex-direction: column;
        }

        .form-group.full-width {
          grid-column: 1 / -1;
        }

        label {
          margin-bottom: 6px;
          color: #333;
          font-weight: 500;
          font-size: 14px;
        }

        select,
        input[type="date"] {
          padding: 8px 12px;
          border: 1px solid #d1d5da;
          border-radius: 6px;
          font-size: 14px;
          transition: border-color 0.2s;
          background-color: white;
        }

        select:disabled,
        input[type="date"]:disabled {
          cursor: not-allowed;
          background-color: #f6f8fa;
          opacity: 0.6;
        }

        select:focus,
        input[type="date"]:focus {
          outline: none;
          border-color: #0366d6;
        }

        select:hover:not(:disabled),
        input[type="date"]:hover:not(:disabled) {
          border-color: #0366d6;
        }

        .button-group {
          display: flex;
          gap: 10px;
          margin-top: 15px;
        }

        .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .btn-primary {
          background: #24292e;
          color: white;
        }

        .btn-primary:hover {
          background: #444;
        }

        .btn-primary:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        .btn-success {
          background: #28a745;
          color: white;
        }

        .btn-success:hover {
          background: #218838;
        }

        .btn-success:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        // 1126 ìƒˆë¡œì¶”ê°€
        .btn-aws {
          background: #FF9900;
          color: white;
        }

        .btn-aws:hover {
          background: #e08900;
        }

        .btn-aws:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        .loading {
          text-align: center;
          padding: 40px;
          color: #666;
          font-size: 14px;
        }

        .loading::after {
          content: "...";
          animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
          0%,
          20% {
            content: ".";
          }
          40% {
            content: "..";
          }
          60%,
          100% {
            content: "...";
          }
        }

        .error-message {
          background: #fff5f5;
          color: #d73a49;
          padding: 12px;
          border-radius: 6px;
          margin-bottom: 15px;
          border: 1px solid #fdd;
          font-size: 14px;
        }

        .success-message {
          background: #f0fff4;
          color: #28a745;
          padding: 12px;
          border-radius: 6px;
          margin-bottom: 15px;
          border: 1px solid #c6f6d5;
          font-size: 14px;
        }

        .info-message {
          background: #f0f8ff;
          color: #0366d6;
          padding: 12px;
          border-radius: 6px;
          margin-bottom: 15px;
          border: 1px solid #bee5eb;
          font-size: 14px;
        }

        .commits-section {
          margin-top: 20px;
        }

        .commits-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        }

        .commits-header h2 {
          color: #333;
          font-size: 18px;
          font-weight: 500;
        }

        .commit-count {
          background: #f6f8fa;
          color: #333;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 13px;
          border: 1px solid #e1e4e8;
        }

        .empty-state {
          text-align: center;
          padding: 40px 20px;
          color: #666;
        }

        .empty-state-icon {
          font-size: 48px;
          margin-bottom: 15px;
        }

        .empty-state h3 {
          color: #333;
          margin-bottom: 8px;
          font-size: 16px;
        }

        .empty-state p {
          color: #666;
          font-size: 14px;
        }

        @media (max-width: 768px) {
          body {
            padding: 10px;
          }

          .container {
            padding: 20px;
          }

          .form-row {
            grid-template-columns: 1fr;
          }

          .header {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
          }

          h1 {
            font-size: 20px;
          }

          .button-group {
            flex-direction: column;
            width: 100%;
          }

          .btn {
            width: 100%;
          }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>GitNote - ì»¤ë°‹ ì¡°íšŒ</h1>
        <div class="user-info">
            <img id="userAvatar" src="" alt="User" />
            <span class="username" id="username"></span>
            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="messageBox"></div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="filter-section">
        <div class="form-row">
            <div class="form-group full-width">
                <label for="repositorySelect">ë¦¬í¬ì§€í† ë¦¬</label>
                <select id="repositorySelect">
                    <option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <div
                        id="selectedRepoInfo"
                        style="margin-top: 8px; font-size: 12px; color: #666"
                ></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="sinceDate">ì‹œì‘ ë‚ ì§œ</label>
                <input type="date" id="sinceDate" />
            </div>
            <div class="form-group">
                <label for="untilDate">ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="date" id="untilDate" />
            </div>
        </div>
        <div class="button-group">
            <button
                    class="btn btn-primary"
                    id="searchBtn"
                    onclick="searchCommits()"
            >
                ì»¤ë°‹ ì¡°íšŒ
            </button>
            <button
                    class="btn btn-success"
                    id="copyBtn"
                    onclick="copyCommitsText()"
                    disabled
                    style="display: none"
            >
                í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>

            <button class="btn btn-aws" id="s3UploadBtn" onclick="uploadToS3()" disabled style="display: none">
                â˜ï¸ S3 ì—…ë¡œë“œ
            </button>
        </div>
    </div>

    <!-- ë¡œë”© ë° ê²°ê³¼ ì„¹ì…˜ -->
    <div id="loadingBox" style="display: none">
        <div class="loading">ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <div id="commitsSection" style="display: none">
        <div class="commits-header">
            <h2>ì»¤ë°‹ ëª©ë¡</h2>
            <span class="commit-count" id="commitCount">0ê°œ</span>
        </div>
        <div id="commitsList"></div>
    </div>

    <div id="emptyState" style="display: none">
        <div class="empty-state">
            <div class="empty-state-icon">-</div>
            <h3>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì„ íƒí•œ ê¸°ê°„ì— ì»¤ë°‹ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    let currentCommits = [];
    let selectedRepo = null;
    let currentCommitsText = ""; // í˜„ì¬ ì»¤ë°‹ í…ìŠ¤íŠ¸ ì €ì¥

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    async function init() {
      console.log("ğŸ”§ Initializing commits page...");

      // ì‚¬ìš©ì ì •ë³´ í™•ì¸
      const username = sessionStorage.getItem("username");
      const avatar = sessionStorage.getItem("avatar");

      console.log("SessionStorage - Username:", username);
      console.log("SessionStorage - Avatar:", avatar ? "ìˆìŒ" : "ì—†ìŒ");

      if (!username) {
        console.warn("âš ï¸ Username not found in sessionStorage");
        showMessage(
          "âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...",
          "error"
        );
        setTimeout(() => {
          sessionStorage.clear();
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      document.getElementById("username").textContent = username;
      document.getElementById("userAvatar").src =
        avatar || "https://via.placeholder.com/50";

      // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ìµœê·¼ 7ì¼)
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(today.getDate() - 7);

      document.getElementById("untilDate").value = today
        .toISOString()
        .split("T")[0];
      document.getElementById("sinceDate").value = weekAgo
        .toISOString()
        .split("T")[0];

      // Rate Limit í™•ì¸ (ì„ íƒì )
      checkRateLimit();

      // ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡ ë¡œë“œ
      await loadRepositories();
    }

    // GitHub API Rate Limit í™•ì¸
    async function checkRateLimit() {
      try {
        const response = await fetch(`${API_BASE}/api/github/rate-limit`, {
          credentials: "include",
        });

        if (response.ok) {
          const data = await response.json();
          const core = data.resources?.core;

          if (core) {
            console.log(
              `GitHub API Rate Limit: ${core.remaining}/${
                core.limit
              } (Reset: ${new Date(core.reset * 1000).toLocaleString(
                "ko-KR"
              )})`
            );

            // Rate limitì´ ë‚®ìœ¼ë©´ ê²½ê³  í‘œì‹œ
            if (core.remaining < 10) {
              showMessage(
                `âš ï¸ GitHub API ìš”ì²­ í•œë„ê°€ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (${
                  core.remaining
                }/${core.limit}) ì¬ì„¤ì • ì‹œê°„: ${new Date(
                  core.reset * 1000
                ).toLocaleTimeString("ko-KR")}`,
                "error"
              );
            }
          }
        }
      } catch (error) {
        console.error("Rate limit check failed:", error);
      }
    }

    // ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡ ë¡œë“œ
    async function loadRepositories() {
      const select = document.getElementById("repositorySelect");
      const filterSection = document.querySelector(".filter-section");

      // ê¸°ì¡´ ì¬ì‹œë„ ë²„íŠ¼ ì œê±°
      const existingRetryBtn = document.getElementById("retryBtn");
      if (existingRetryBtn) {
        existingRetryBtn.remove();
      }

      select.innerHTML =
        '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
      select.disabled = true;

      console.log(
        "ğŸ”„ Loading repositories from:",
        `${API_BASE}/api/github/repositories`
      );

      try {
        const response = await fetch(`${API_BASE}/api/github/repositories`, {
          method: "GET",
          credentials: "include",
          headers: {
            Accept: "application/json",
          },
        });

        console.log("Response status:", response.status);

        // ì‘ë‹µ ë°ì´í„° ë¨¼ì € ì½ê¸°
        const data = await response.json();
        console.log("âœ… Response received:", {
          status: response.status,
          count: data.count,
          hasRepositories: data.repositories ? "Yes" : "No",
          repositoriesLength: data.repositories
            ? data.repositories.length
            : 0,
        });

        // ì²« ë²ˆì§¸ ë¦¬í¬ì§€í† ë¦¬ ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)
        if (data.repositories && data.repositories.length > 0) {
          console.log("ğŸ“¦ First repository:", data.repositories[0]);
        }

        // ë¡œê·¸ì¸ í•„ìš”
        if (!response.ok) {
          if (data.needLogin === "true" || response.status === 401) {
            showMessage(
              "âš ï¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.",
              "error"
            );
            setTimeout(() => {
              sessionStorage.clear();
              window.location.href = "index.html";
            }, 2000);
            return;
          }

          // Rate limit
          if (response.status === 429) {
            select.innerHTML = '<option value="">â±ï¸ API í•œë„ ì´ˆê³¼</option>';
            showMessage(
              "âš ï¸ " + (data.error || "GitHub API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."),
              "error"
            );
            addRetryButton();
            return;
          }

          // ê¸°íƒ€ ì—ëŸ¬
          throw new Error(
            data.error || "ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }

        // ì„±ê³µ
        select.innerHTML =
          '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

        if (data.repositories && data.repositories.length > 0) {
          data.repositories.forEach((repo) => {
            // full_name(snake_case) ë˜ëŠ” fullName(camelCase) ì§€ì›
            const fullName = repo.fullName || repo.full_name;
            const isPrivate = repo.isPrivate || repo.private;

            // í•„ìˆ˜ ë°ì´í„° ê²€ì¦
            if (!fullName || !repo.name) {
              console.warn(
                "âš ï¸ Invalid repository data (missing name or fullName):",
                repo
              );
              return; // ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” ê±´ë„ˆë›°ê¸°
            }

            const parts = fullName.split("/");
            const owner = parts.length > 1 ? parts[0] : repo.name;

            const option = document.createElement("option");
            option.value = JSON.stringify({
              owner: owner,
              name: repo.name,
              fullName: fullName,
            });
            option.textContent = `${fullName}${
              isPrivate ? " (Private)" : ""
            }`;
            select.appendChild(option);
          });

          showMessage(
            `âœ… ${data.count}ê°œì˜ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`,
            "success"
          );
        } else {
          select.innerHTML =
            '<option value="">ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
          showMessage("â„¹ï¸ ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.", "info");
        }

        select.disabled = false;

        // ë¦¬í¬ì§€í† ë¦¬ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        select.addEventListener("change", function () {
          const selectedRepoInfo =
            document.getElementById("selectedRepoInfo");

          if (this.value) {
            try {
              const repoData = JSON.parse(this.value);
              console.log("âœ… ë¦¬í¬ì§€í† ë¦¬ ì„ íƒë¨:", repoData);
              selectedRepoInfo.innerHTML = `ì„ íƒë¨: <strong>${repoData.fullName}</strong>`;
              selectedRepoInfo.style.color = "#28a745";
            } catch (e) {
              console.error("âŒ ë¦¬í¬ì§€í† ë¦¬ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
              selectedRepoInfo.innerHTML = `ì„ íƒ ì˜¤ë¥˜`;
              selectedRepoInfo.style.color = "#d73a49";
            }
          } else {
            selectedRepoInfo.innerHTML = "";
          }
        });
      } catch (error) {
        console.error("âŒ Repository loading error:", error);

        select.innerHTML = '<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>';
        select.disabled = false;

        showMessage("âŒ " + error.message, "error");
        addRetryButton();
      }
    }

    // ì¬ì‹œë„ ë²„íŠ¼ ì¶”ê°€
    function addRetryButton() {
      const existingRetryBtn = document.getElementById("retryBtn");
      if (existingRetryBtn) return; // ì´ë¯¸ ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ

      const retryBtn = document.createElement("button");
      retryBtn.id = "retryBtn";
      retryBtn.className = "btn btn-primary";
      retryBtn.innerHTML = "ğŸ”„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°";
      retryBtn.style.marginTop = "15px";
      retryBtn.style.marginBottom = "15px";
      retryBtn.onclick = () => {
        retryBtn.remove();
        loadRepositories();
      };

      const filterSection = document.querySelector(".filter-section");
      const buttonGroup = document.querySelector(".button-group");
      filterSection.insertBefore(retryBtn, buttonGroup);
    }

    // ì»¤ë°‹ ì¡°íšŒ
    async function searchCommits() {
      console.log("ğŸ” ì»¤ë°‹ ì¡°íšŒ ì‹œì‘...");

      const repoSelect = document.getElementById("repositorySelect");
      const since = document.getElementById("sinceDate").value;
      const until = document.getElementById("untilDate").value;

      console.log("Select element:", {
        exists: !!repoSelect,
        value: repoSelect ? repoSelect.value : "N/A",
        selectedIndex: repoSelect ? repoSelect.selectedIndex : "N/A",
        optionsCount: repoSelect ? repoSelect.options.length : "N/A",
      });

      if (!repoSelect || !repoSelect.value || repoSelect.value === "") {
        console.warn("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ê°€ ì„ íƒë˜ì§€ ì•ŠìŒ");
        showMessage("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      if (!since || !until) {
        console.warn("âš ï¸ ë‚ ì§œê°€ ì„ íƒë˜ì§€ ì•ŠìŒ");
        showMessage("âš ï¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        selectedRepo = JSON.parse(repoSelect.value);
        console.log("âœ… ì„ íƒëœ ë¦¬í¬ì§€í† ë¦¬:", selectedRepo);
      } catch (e) {
        console.error("âŒ ë¦¬í¬ì§€í† ë¦¬ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:", e);
        showMessage("âŒ ë¦¬í¬ì§€í† ë¦¬ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
        return;
      }

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("loadingBox").style.display = "block";
      document.getElementById("commitsSection").style.display = "none";
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("searchBtn").disabled = true;
      document.getElementById("copyBtn").disabled = true;
      document.getElementById("copyBtn").style.display = "none";

      // 1126 ìƒˆë¡œì¶”ê°€
      document.getElementById("copyBtn").style.display = "none";      // ë³µì‚¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      document.getElementById("s3UploadBtn").style.display = "none";  // S3 ë²„íŠ¼ ìˆ¨ê¸°ê¸°

      try {
        const url = `${API_BASE}/api/github/commits?owner=${encodeURIComponent(
          selectedRepo.owner
        )}&repo=${encodeURIComponent(
          selectedRepo.name
        )}&since=${since}&until=${until}&includeDetails=false`;

        const response = await fetch(url, {
          credentials: "include",
        });

        if (!response.ok) {
          throw new Error("ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const data = await response.json();
        currentCommits = data.commits;

        displayCommits(data.commits);
      } catch (error) {
        showMessage(error.message, "error");
      } finally {
        document.getElementById("loadingBox").style.display = "none";
        document.getElementById("searchBtn").disabled = false;
      }
    }

    // ì»¤ë°‹ ëª©ë¡ í‘œì‹œ (í…ìŠ¤íŠ¸ í˜•íƒœ)
    function displayCommits(commits) {
      if (commits.length === 0) {
        document.getElementById("emptyState").style.display = "block";
        document.getElementById("copyBtn").style.display = "none";
        return;
      }

      document.getElementById("commitsSection").style.display = "block";
      document.getElementById(
        "commitCount"
      ).textContent = `${commits.length}ê°œ`;

      const commitsList = document.getElementById("commitsList");



      // í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì»¤ë°‹ ëª©ë¡ ìƒì„±
      let textContent = "";
      textContent += `ë¦¬í¬ì§€í† ë¦¬: ${selectedRepo?.fullName || "Unknown"}\n`;
      textContent += `ì¡°íšŒ ê¸°ê°„: ${
        document.getElementById("sinceDate").value
      } ~ ${document.getElementById("untilDate").value}\n`;
      textContent += `ì´ ì»¤ë°‹ ìˆ˜: ${commits.length}\n`;
      textContent += `${"=".repeat(80)}\n\n`;

      commits.forEach((commit, index) => {
        const message = commit.commit?.message || "No message";
        const authorName = commit.commit?.author?.name || "Unknown";
        const authorEmail = commit.commit?.author?.email || "";
        const authorDate = commit.commit?.author?.date || "";
        const sha = commit.sha || "";
        const url = commit.htmlUrl || commit.html_url || "";

        const date = authorDate ? new Date(authorDate).toISOString() : "";

        // í•œ ì¤„ì”© êµ¬ë¶„í•˜ì—¬ íŒŒì‹±í•˜ê¸° ì‰½ê²Œ
        textContent += `[${index + 1}] ${sha.substring(0, 7)}\n`;
        textContent += `ë©”ì‹œì§€: ${message}\n`;
        textContent += `ì‘ì„±ì: ${authorName}`;
        if (authorEmail) textContent += ` <${authorEmail}>`;
        textContent += `\n`;
        textContent += `ë‚ ì§œ: ${date}\n`;
        textContent += `URL: ${url}\n`;
        textContent += `${"=".repeat(80)}\n\n`;
      });

      // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë³µì‚¬ìš©)
      currentCommitsText = textContent;

      // pre íƒœê·¸ë¡œ ê°ì‹¸ì„œ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ í‘œì‹œ
      commitsList.innerHTML = `<pre style="
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        color: #333;
        max-height: 600px;
        overflow-y: auto;
      ">${escapeHtml(textContent)}</pre>`;

      // ë³µì‚¬ ë²„íŠ¼ í™œì„±í™”
      const copyBtn = document.getElementById("copyBtn");
      copyBtn.style.display = "inline-block";
      copyBtn.disabled = false;

       // 1126 ìƒˆë¡œì¶”ê°€
       // S3 ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
       const s3Btn = document.getElementById("s3UploadBtn");
       s3Btn.style.display = "inline-block";
       s3Btn.disabled = false;
    }


    // í…ìŠ¤íŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°
    // í…ìŠ¤íŠ¸ ë³µì‚¬ í•¨ìˆ˜
    async function copyCommitsText() {
      if (!currentCommitsText) {
        showMessage("ë³µì‚¬í•  ì»¤ë°‹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
      }

      try {
        await navigator.clipboard.writeText(currentCommitsText);
        showMessage("âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„ì‹œ ë³€ê²½
        const copyBtn = document.getElementById("copyBtn");
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = "ë³µì‚¬ë¨!";
        copyBtn.style.background = "#28a745";

        setTimeout(() => {
          copyBtn.innerHTML = originalText;
          copyBtn.style.background = "";
        }, 2000);
      } catch (error) {
        console.error("ë³µì‚¬ ì‹¤íŒ¨:", error);
        showMessage("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message, "error");
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      try {
        await fetch(`${API_BASE}/api/logout`, {
          method: "POST",
          credentials: "include",
        });

        sessionStorage.clear();
        window.location.href = "index.html";
      } catch (error) {
        console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
        sessionStorage.clear();
        window.location.href = "index.html";
      }
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    function showMessage(message, type = "info") {
      const messageBox = document.getElementById("messageBox");
      const className =
        type === "error"
          ? "error-message"
          : type === "success"
          ? "success-message"
          : "info-message";

      messageBox.innerHTML = `<div class="${className}">${message}</div>`;

      setTimeout(() => {
        messageBox.innerHTML = "";
      }, 5000);
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener("DOMContentLoaded", init);

    // 1126 ìƒˆë¡œì¶”ê°€
    async function uploadToS3() {
        if (!currentCommitsText) {
            showMessage("ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }

        const s3Btn = document.getElementById("s3UploadBtn");
        const originalText = s3Btn.innerHTML;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        s3Btn.disabled = true;
        s3Btn.innerHTML = "â˜ï¸ ì—…ë¡œë“œ ì¤‘...";

        try {
            // ë°±ì—”ë“œë¡œ ë³´ë‚¼ ë°ì´í„° êµ¬ì„±
            const payload = {
                repositoryName: selectedRepo.fullName,
                startDate: document.getElementById("sinceDate").value,
                endDate: document.getElementById("untilDate").value,
                content: currentCommitsText
            };

            const response = await fetch(`${API_BASE}/api/s3/upload`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "S3 ì—…ë¡œë“œ ì‹¤íŒ¨");
            }

            const result = await response.json();
            // result.urlì€ ë°±ì—”ë“œì—ì„œ ë°˜í™˜í•´ì£¼ëŠ” íŒŒì¼ ì ‘ê·¼ URLì´ë¼ê³  ê°€ì •
            showMessage(`âœ… S3 ì—…ë¡œë“œ ì„±ê³µ!`, "success");
            console.log("Uploaded URL:", result.url);

        } catch (error) {
            console.error("S3 Upload Error:", error);
            showMessage("âŒ " + error.message, "error");
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            s3Btn.disabled = false;
            s3Btn.innerHTML = originalText;
        }
    }
// â–²â–²â–² [ì—¬ê¸°ê¹Œì§€ ì¶”ê°€] â–²â–²â–²
</script>
</body>
</html>
