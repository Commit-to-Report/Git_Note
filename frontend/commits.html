<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ì¡°íšŒ</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://gitnote.app/commits.html" />
    <meta property="og:title" content="GitNote - ì»¤ë°‹ ì¡°íšŒ" />
    <meta property="og:description" content="GitHub ë¦¬í¬ì§€í† ë¦¬ì˜ ì»¤ë°‹ì„ ê¸°ê°„ë³„ë¡œ ì¡°íšŒí•˜ê³  ë¶„ì„í•˜ì„¸ìš”." />
    <meta property="og:image" content="https://gitnote.app/img/logo_text.png" />
    <meta property="og:site_name" content="GitNote" />

    <link href="https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.3/packages/wanted-sans/dist/css/wanted-sans.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/footer.css" />
    <link rel="stylesheet" href="./css/commits.css" />

    <style>
        /* 1. í°íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœìƒë‹¨) */
        @import url("https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.3/packages/wanted-sans/dist/css/wanted-sans.css");

        /* [ìˆ˜ì • 1] bodyì—ë§Œ í°íŠ¸ ì ìš© (ì¤‘ìš”: * ëŒ€ì‹  body ì‚¬ìš©) */
        /* ì´ë ‡ê²Œ í•´ì•¼ header.cssì— ìˆëŠ” êµµê¸°(font-weight) ì„¤ì •ì´ ë¨¹í™ë‹ˆë‹¤! */
        body {
            font-family: "Wanted Sans", -apple-system, BlinkMacSystemFont, system-ui,
            Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo",
            "Noto Sans KR", "Malgun Gothic", sans-serif !important;
        }

        /* [ìˆ˜ì • 2] ì…ë ¥ í•„ë“œ, ë²„íŠ¼ì€ í°íŠ¸ ìƒì† ê°•ì œ (êµµê¸°ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ) */
        select, input, button, textarea, pre {
            font-family: "Wanted Sans", sans-serif !important;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .action-button-group {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: right;
            display: none;
        }

        /* =========================================
           ğŸŒ™ ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ (ë¶€ë“œëŸ¬ìš´ í†¤)
           ========================================= */

        /* 1. ì „ì²´ ë°°ê²½ ë° í…ìŠ¤íŠ¸ */
        body.dark-mode {
            background-color: #1a1a1a !important;
            color: #e0e0e0;
        }

        /* 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        body.dark-mode .container {
            background: #282828;
            border-color: #444;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        /* 3. í—¤ë” ë° ì œëª© */
        body.dark-mode .page-header {
            border-bottom: 2px solid #444;
        }
        body.dark-mode h1 {
            color: #f0f0f0;
        }

        /* 4. ì‚¬ìš©ì ì •ë³´ */
        body.dark-mode .user-info {
            background-color: #3a3a3a;
            border-color: #555;
        }
        body.dark-mode .user-info img {
            border: 2px solid #282828;
            box-shadow: 0 0 0 1px #555;
        }
        body.dark-mode .user-info .username {
            color: #d0d0d0;
        }

        /* 5. í•„í„° ì„¹ì…˜ */
        body.dark-mode .filter-section {
            background: #282828;
        }
        body.dark-mode label {
            color: #d0d0d0;
        }

        /* 6. ì…ë ¥ í•„ë“œ */
        body.dark-mode select,
        body.dark-mode input[type="date"] {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f0f0f0;
        }
        body.dark-mode select:focus,
        body.dark-mode input[type="date"]:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        body.dark-mode #selectedRepoInfo {
            color: #a0a0a0 !important;
        }
        body.dark-mode #selectedRepoInfo strong {
            color: #81c784 !important;
        }

        /* 7. ë²„íŠ¼ */
        body.dark-mode .btn-primary {
            background: #4f46e5;
        }
        body.dark-mode .btn-primary:hover:not(:disabled) {
            background: #4338ca;
        }

        /* 8. ë¡œë”©, ì»¤ë°‹ ì¹´ìš´íŠ¸ */
        body.dark-mode .loading {
            color: #a0a0a0;
        }
        body.dark-mode .commit-count {
            background: #36495c;
            color: #90caf9;
        }
        body.dark-mode .commits-header h2 {
            color: #f0f0f0;
        }
        body.dark-mode .commits-header {
            border-left-color: #6366f1;
        }

        /* 9. ì»¤ë°‹ ë°•ìŠ¤ */
        body.dark-mode #commitsList pre {
            background: #212121 !important;
            color: #e0e0e0 !important;
            border: 1px solid #444;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }

        /* 10. ë©”ì‹œì§€ ë°•ìŠ¤ */
        body.dark-mode .error-message { background: #3a1c1c; color: #f47d7d; border: 1px solid #5a2c2c; }
        body.dark-mode .success-message { background: #1c3a2a; color: #84e4a7; border: 1px solid #2c5a3c; }
        body.dark-mode .info-message { background: #1c2a3a; color: #84a7e4; border: 1px solid #2c3c5a; }

        /* 11. êµ¬ë¶„ì„  */
        body.dark-mode .action-button-group {
            border-top: 1px solid #444;
        }

        /* 12. ë¹ˆ ìƒíƒœ */
        body.dark-mode .empty-state h3 {
            color: #d0d0d0;
        }
        body.dark-mode .empty-state p {
            color: #a0a0a0;
        }
        body.dark-mode .empty-state-icon {
            color: #666;
            border-color: #444;
        }
    </style>
</head>
<body>
<div id="header-container"></div>

<main>
    <div class="container">
        <div class="page-header">
            <h1>GitNote - ì»¤ë°‹ ì¡°íšŒ</h1>
        </div>

        <div id="messageBox"></div>

        <div class="filter-section">
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="repositorySelect">ë¦¬í¬ì§€í† ë¦¬</label>
                    <select id="repositorySelect">
                        <option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                    </select>
                    <div id="selectedRepoInfo" style="margin-top: 8px; font-size: 12px; color: #666"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sinceDate">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" id="sinceDate" />
                </div>
                <div class="form-group">
                    <label for="untilDate">ì¢…ë£Œ ë‚ ì§œ</label>
                    <input type="date" id="untilDate" />
                </div>
            </div>

            <div class="button-group" style="margin-top: 10px">
                <button class="btn btn-primary" id="searchBtn" onclick="searchCommits()">
                    ğŸ” ì»¤ë°‹ ì¡°íšŒ
                </button>
            </div>
        </div>

        <div id="loadingBox" style="display: none">
            <div class="loading">ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
        </div>

        <div id="commitsSection" style="display: none">
            <div class="commits-header">
                <h2>ì»¤ë°‹ ëª©ë¡</h2>
                <span class="commit-count" id="commitCount">0ê°œ</span>
            </div>

            <div id="commitsList"></div>

            <div class="action-button-group" id="actionButtons">
                <button class="btn btn-success" id="copyBtn" onclick="copyCommitsText()">
                    í…ìŠ¤íŠ¸ ë³µì‚¬
                </button>

                <button class="btn btn-aws" id="s3UploadBtn" onclick="uploadToS3()">
                    â˜ï¸ ì €ì¥í•˜ê¸°
                </button>

                <button class="btn btn-report" id="generateReportBtn" onclick="goToReport()" disabled style="display: none; margin-left: 10px">
                    ğŸ“„ ë³´ê³ ì„œ ìƒì„±
                </button>
            </div>
        </div>

        <div id="emptyState" style="display: none">
            <div class="empty-state">
                <div class="empty-state-icon">-</div>
                <h3>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì„ íƒí•œ ê¸°ê°„ì— ì»¤ë°‹ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
            </div>
        </div>
    </div>
</main>

<div id="footer-container"></div>

<script src="js/config.js"></script>
<script src="js/header.js"></script>
<script src="js/footer.js"></script>
<script>
    const API_BASE = window.API_BASE_URL;
    let currentCommits = [];
    let selectedRepo = null;
    let currentCommitsText = "";
    let uploadedFileUrl = "";

    async function init() {
        const username = sessionStorage.getItem("username");

        if (!username) {
            showMessage("âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
            setTimeout(() => {
                window.location.href = "index.html";
            }, 2000);
            return;
        }

        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);

        document.getElementById("untilDate").value = today.toISOString().split("T")[0];
        document.getElementById("sinceDate").value = weekAgo.toISOString().split("T")[0];

        await loadRepositories();
    }

    async function loadRepositories() {
        const select = document.getElementById("repositorySelect");
        try {
            const response = await fetch(`${window.API_BASE_URL}/api/github/repositories`, {
                credentials: "include",
            });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "ë¦¬í¬ì§€í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");

            select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            if (data.repositories && data.repositories.length > 0) {
                data.repositories.forEach((repo) => {
                    const fullName = repo.fullName || repo.full_name;
                    const option = document.createElement("option");
                    option.value = JSON.stringify({
                        owner: repo.owner || fullName.split("/")[0],
                        name: repo.name,
                        fullName,
                    });
                    option.textContent = fullName + (repo.isPrivate ? " (Private)" : "");
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
            }
        } catch (error) {
            select.innerHTML = '<option value="">ë¡œë“œ ì‹¤íŒ¨</option>';
            showMessage("âŒ " + error.message, "error");
        }
        select.addEventListener("change", function () {
            const info = document.getElementById("selectedRepoInfo");
            if (this.value) {
                const data = JSON.parse(this.value);
                selectedRepo = data;
                info.innerHTML = `ì„ íƒë¨: <strong>${data.fullName}</strong>`;
                info.style.color = "#28a745";
            } else {
                selectedRepo = null;
                info.innerHTML = "";
            }
        });
    }

    async function searchCommits() {
        if (!selectedRepo) {
            showMessage("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
            return;
        }
        const since = document.getElementById("sinceDate").value;
        const until = document.getElementById("untilDate").value;

        document.getElementById("loadingBox").style.display = "block";
        document.getElementById("commitsSection").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("searchBtn").disabled = true;

        currentCommitsText = "";
        uploadedFileUrl = "";
        document.getElementById("generateReportBtn").style.display = "none";

        try {
            const url = `${window.API_BASE_URL}/api/github/commits?owner=${encodeURIComponent(selectedRepo.owner)}&repo=${encodeURIComponent(selectedRepo.name)}&since=${since}&until=${until}&includeDetails=false`;
            const response = await fetch(url, { credentials: "include" });
            if (!response.ok) throw new Error("ì»¤ë°‹ ì¡°íšŒ ì‹¤íŒ¨");

            const data = await response.json();
            displayCommits(data.commits);
        } catch (error) {
            showMessage("âŒ " + error.message, "error");
        } finally {
            document.getElementById("loadingBox").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
        }
    }

    function displayCommits(commits) {
        if (!commits || commits.length === 0) {
            document.getElementById("emptyState").style.display = "block";
            return;
        }

        document.getElementById("commitsSection").style.display = "block";
        document.getElementById("commitCount").textContent = `${commits.length}ê°œ`;

        let textContent = `ë¦¬í¬ì§€í† ë¦¬: ${selectedRepo?.fullName}\n`;
        textContent += `ì¡°íšŒ ê¸°ê°„: ${document.getElementById("sinceDate").value} ~ ${document.getElementById("untilDate").value}\n`;
        textContent += `ì´ ì»¤ë°‹ ìˆ˜: ${commits.length}\n${"=".repeat(50)}\n\n`;

        commits.forEach((commit, index) => {
            const message = commit.commit?.message || "No message";
            const date = commit.commit?.author?.date || "";
            textContent += `[${index + 1}] ${date.substring(0, 10)} - ${message}\n`;
        });

        currentCommitsText = textContent;
        document.getElementById("commitsList").innerHTML = `<pre>${escapeHtml(textContent)}</pre>`;
        document.getElementById("actionButtons").style.display = "block";
    }

    async function copyCommitsText() {
        if (!currentCommitsText) {
            showMessage("ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }
        try {
            await navigator.clipboard.writeText(currentCommitsText);
            showMessage("âœ… ë³µì‚¬ ì™„ë£Œ!", "success");
        } catch (e) {
            showMessage("âŒ ë³µì‚¬ ì‹¤íŒ¨", "error");
        }
    }

    async function uploadToS3() {
        if (!currentCommitsText) {
            showMessage("âš ï¸ ì—…ë¡œë“œí•  ì»¤ë°‹ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¡°íšŒí•´ì£¼ì„¸ìš”.", "error");
            return;
        }

        const username = sessionStorage.getItem("username");
        const s3Btn = document.getElementById("s3UploadBtn");
        s3Btn.disabled = true;
        s3Btn.innerHTML = "â˜ï¸ ì—…ë¡œë“œ ì¤‘...";

        try {
            const payload = {
                username: username,
                repositoryName: selectedRepo.fullName,
                startDate: document.getElementById("sinceDate").value,
                endDate: document.getElementById("untilDate").value,
                content: currentCommitsText,
            };

            const response = await fetch(`${window.API_BASE_URL}/api/s3/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");

            const result = await response.json();
            uploadedFileUrl = result.url;
            showMessage("âœ… ì €ì¥ ì„±ê³µ!", "success");

            const reportBtn = document.getElementById("generateReportBtn");
            reportBtn.disabled = false;
            reportBtn.style.display = "inline-block";
        } catch (error) {
            console.error(error);
            showMessage("âŒ " + error.message, "error");
        } finally {
            s3Btn.disabled = false;
            s3Btn.innerHTML = "â˜ï¸ ì €ì¥í•˜ê¸° ";
        }
    }

    function goToReport() {
        if (!uploadedFileUrl) return;
        let fileKey = uploadedFileUrl;
        if (uploadedFileUrl.startsWith("http")) {
            try {
                const urlObj = new URL(uploadedFileUrl);
                fileKey = urlObj.pathname.substring(1);
            } catch (e) {
                console.warn("URL íŒŒì‹± ì‹¤íŒ¨");
            }
        }
        window.location.href = `report.html?fileKey=${encodeURIComponent(fileKey)}`;
    }

    function showMessage(msg, type = "info") {
        const box = document.getElementById("messageBox");
        box.innerHTML = `<div class="${type === "error" ? "error-message" : "success-message"}">${msg}</div>`;
        setTimeout(() => { box.innerHTML = ""; }, 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    // [ë‹¤í¬ëª¨ë“œ ì‹¤í–‰ í•¨ìˆ˜]
    function checkDarkMode() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }

    checkDarkMode();
    setInterval(checkDarkMode, 100);

    // [ì¤‘ë³µ ì‚­ì œ] ë§ˆì§€ë§‰ì— í•˜ë‚˜ë§Œ ë‚¨ê¹€
    window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>