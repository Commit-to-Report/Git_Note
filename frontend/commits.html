<!DOCTYPE html>
<html lang="ko">
<head>
    /* commit.html */
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ì¡°íšŒ</title>

    <link rel="stylesheet" href="./css/commits.css" />
</head>
<body>
<div class="container">
    <div class="header">
        <h1>GitNote - ì»¤ë°‹ ì¡°íšŒ</h1>
        <div class="user-info">
            <img id="userAvatar" src="" alt="User" />
            <span class="username" id="username"></span>
            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="messageBox"></div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="filter-section">
        <div class="form-row">
            <div class="form-group full-width">
                <label for="repositorySelect">ë¦¬í¬ì§€í† ë¦¬</label>
                <select id="repositorySelect">
                    <option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <div
                        id="selectedRepoInfo"
                        style="margin-top: 8px; font-size: 12px; color: #666"
                ></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="sinceDate">ì‹œì‘ ë‚ ì§œ</label>
                <input type="date" id="sinceDate" />
            </div>
            <div class="form-group">
                <label for="untilDate">ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="date" id="untilDate" />
            </div>
        </div>
        <div class="button-group">
            <button
                    class="btn btn-primary"
                    id="searchBtn"
                    onclick="searchCommits()"
            >
                ì»¤ë°‹ ì¡°íšŒ
            </button>
            <button
                    class="btn btn-success"
                    id="copyBtn"
                    onclick="copyCommitsText()"
                    disabled
                    style="display: none"
            >
                í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>

            <button class="btn btn-aws" id="s3UploadBtn" onclick="uploadToS3()" disabled style="display: none">
                â˜ï¸ S3 ì—…ë¡œë“œ
            </button>

            <button class="btn btn-report" id="generateReportBtn" onclick="goToReport()" disabled style="display: none">
                ğŸ“„ ë³´ê³ ì„œ ìƒì„±
            </button>
        </div>
    </div>

    <!-- ë¡œë”© ë° ê²°ê³¼ ì„¹ì…˜ -->
    <div id="loadingBox" style="display: none">
        <div class="loading">ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <div id="commitsSection" style="display: none">
        <div class="commits-header">
            <h2>ì»¤ë°‹ ëª©ë¡</h2>
            <span class="commit-count" id="commitCount">0ê°œ</span>
        </div>
        <div id="commitsList"></div>
    </div>

    <div id="emptyState" style="display: none">
        <div class="empty-state">
            <div class="empty-state-icon">-</div>
            <h3>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì„ íƒí•œ ê¸°ê°„ì— ì»¤ë°‹ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    let currentCommits = [];
    let selectedRepo = null;
    let currentCommitsText = "";
    let uploadedFileUrl = ""; // S3 ì—…ë¡œë“œ URL ì €ì¥

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    async function init() {
        const username = sessionStorage.getItem("username");
        const avatar = sessionStorage.getItem("avatar");

        if (!username) {
            showMessage("âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...", "error");
            setTimeout(() => {
                sessionStorage.clear();
                window.location.href = "index.html";
            }, 2000);
            return;
        }

        document.getElementById("username").textContent = username;
        document.getElementById("userAvatar").src =
            avatar || "https://via.placeholder.com/50";

        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);

        document.getElementById("untilDate").value = today.toISOString().split("T")[0];
        document.getElementById("sinceDate").value = weekAgo.toISOString().split("T")[0];

        await loadRepositories();
    }

    async function loadRepositories() {
        const select = document.getElementById("repositorySelect");
        select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
        select.disabled = true;

        try {
            const response = await fetch(`${API_BASE}/api/github/repositories`, { credentials: "include" });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

            select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            if (data.repositories && data.repositories.length > 0) {
                data.repositories.forEach((repo) => {
                    const fullName = repo.fullName || repo.full_name;
                    if (!fullName || !repo.name) return;
                    const option = document.createElement("option");
                    option.value = JSON.stringify({ owner: repo.owner || fullName.split("/")[0], name: repo.name, fullName });
                    option.textContent = fullName + (repo.isPrivate ? " (Private)" : "");
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
            }
            select.disabled = false;

            select.addEventListener("change", function () {
                const selectedRepoInfo = document.getElementById("selectedRepoInfo");
                if (this.value) {
                    try {
                        const repoData = JSON.parse(this.value);
                        selectedRepo = repoData;
                        selectedRepoInfo.innerHTML = `ì„ íƒë¨: <strong>${repoData.fullName}</strong>`;
                        selectedRepoInfo.style.color = "#28a745";
                    } catch (e) {
                        selectedRepoInfo.innerHTML = "ì„ íƒ ì˜¤ë¥˜";
                        selectedRepoInfo.style.color = "#d73a49";
                    }
                } else {
                    selectedRepoInfo.innerHTML = "";
                    selectedRepo = null;
                }
            });

        } catch (error) {
            showMessage("âŒ " + error.message, "error");
        }
    }

    async function searchCommits() {
        if (!selectedRepo) { showMessage("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error"); return; }

        const since = document.getElementById("sinceDate").value;
        const until = document.getElementById("untilDate").value;
        if (!since || !until) { showMessage("âš ï¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error"); return; }

        document.getElementById("loadingBox").style.display = "block";
        document.getElementById("commitsSection").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("searchBtn").disabled = true;

        try {
            const url = `${API_BASE}/api/github/commits?owner=${encodeURIComponent(selectedRepo.owner)}&repo=${encodeURIComponent(selectedRepo.name)}&since=${since}&until=${until}&includeDetails=false`;
            const response = await fetch(url, { credentials: "include" });
            if (!response.ok) throw new Error("ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const data = await response.json();
            currentCommits = data.commits;
            displayCommits(data.commits);

        } catch (error) {
            showMessage("âŒ " + error.message, "error");
        } finally {
            document.getElementById("loadingBox").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
        }
    }

    function displayCommits(commits) {
        if (commits.length === 0) {
            document.getElementById("emptyState").style.display = "block";
            document.getElementById("copyBtn").style.display = "none";
            document.getElementById("s3UploadBtn").style.display = "none";
            return;
        }

        document.getElementById("commitsSection").style.display = "block";
        document.getElementById("commitCount").textContent = `${commits.length}ê°œ`;

        let textContent = `ë¦¬í¬ì§€í† ë¦¬: ${selectedRepo?.fullName || "Unknown"}\n`;
        textContent += `ì¡°íšŒ ê¸°ê°„: ${document.getElementById("sinceDate").value} ~ ${document.getElementById("untilDate").value}\n`;
        textContent += `ì´ ì»¤ë°‹ ìˆ˜: ${commits.length}\n${"=".repeat(80)}\n\n`;

        commits.forEach((commit, index) => {
            const message = commit.commit?.message || "No message";
            const authorName = commit.commit?.author?.name || "Unknown";
            const authorEmail = commit.commit?.author?.email || "";
            const authorDate = commit.commit?.author?.date || "";
            const sha = commit.sha || "";
            const url = commit.htmlUrl || commit.html_url || "";

            textContent += `[${index + 1}] ${sha.substring(0, 7)}\n`;
            textContent += `ë©”ì‹œì§€: ${message}\n`;
            textContent += `ì‘ì„±ì: ${authorName}${authorEmail ? " <"+authorEmail+">" : ""}\n`;
            textContent += `ë‚ ì§œ: ${authorDate ? new Date(authorDate).toISOString() : ""}\n`;
            textContent += `URL: ${url}\n${"=".repeat(80)}\n\n`;
        });

        currentCommitsText = textContent;

        document.getElementById("commitsList").innerHTML = `<pre style="
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        color: #333;
        max-height: 600px;
        overflow-y: auto;
      ">${escapeHtml(textContent)}</pre>`;

        document.getElementById("copyBtn").style.display = "inline-block";
        document.getElementById("copyBtn").disabled = false;
        document.getElementById("s3UploadBtn").style.display = "inline-block";
        document.getElementById("s3UploadBtn").disabled = false;

        // ë³´ê³ ì„œ ë²„íŠ¼ ì´ˆê¸°í™”
        const reportBtn = document.getElementById("generateReportBtn");
        reportBtn.disabled = true;
        reportBtn.style.display = "none";
    }

    async function copyCommitsText() {
        if (!currentCommitsText) { showMessage("ë³µì‚¬í•  ì»¤ë°‹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error"); return; }
        try {
            await navigator.clipboard.writeText(currentCommitsText);
            showMessage("âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
        } catch (error) {
            showMessage("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message, "error");
        }
    }

    async function uploadToS3() {
        if (!currentCommitsText) { showMessage("ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error"); return; }

        const s3Btn = document.getElementById("s3UploadBtn");
        const originalText = s3Btn.innerHTML;

        // [ì¶”ê°€ 1] ì‚¬ìš©ì ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°
        const username = sessionStorage.getItem("username");
        if (!username) {
            showMessage("âŒ ë¡œê·¸ì¸ ì •ë³´(ì‚¬ìš©ìëª…)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        s3Btn.disabled = true;
        s3Btn.innerHTML = "â˜ï¸ ì—…ë¡œë“œ ì¤‘...";

        try {
            const payload = {
                // [ì¶”ê°€ 2] username í•„ë“œ ì¶”ê°€ (S3Controllerì—ì„œ í•„ìˆ˜ë¡œ ìš”ì²­í•¨)
                username: username,
                repositoryName: selectedRepo.fullName,
                startDate: document.getElementById("sinceDate").value, // startDateëŠ” í˜„ì¬ DTOì— ì—†ì§€ë§Œ, ì¶”í›„ í•„ìš”í•  ê²½ìš°ë¥¼ ìœ„í•´ ìœ ì§€
                endDate: document.getElementById("untilDate").value,   // endDateëŠ” í˜„ì¬ DTOì— ì—†ì§€ë§Œ, ì¶”í›„ í•„ìš”í•  ê²½ìš°ë¥¼ ìœ„í•´ ìœ ì§€
                content: currentCommitsText
            };

            const response = await fetch(`${API_BASE}/api/s3/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "S3 ì—…ë¡œë“œ ì‹¤íŒ¨");
            }

            const result = await response.json();
            uploadedFileUrl = result.url; // ì„œë²„ì—ì„œ ë°˜í™˜ëœ URL ì €ì¥
            showMessage(`âœ… S3 ì—…ë¡œë“œ ì„±ê³µ!`, "success");

            // ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ í™œì„±í™”
            const reportBtn = document.getElementById("generateReportBtn");
            reportBtn.disabled = false;
            reportBtn.style.display = "inline-block";

        } catch (error) {
            console.error("S3 Upload Error:", error);
            // ë°±ì—”ë“œì—ì„œ ë°›ì€ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            showMessage("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message, "error");
        } finally {
            s3Btn.disabled = false;
            s3Btn.innerHTML = originalText;
        }
    }

// commit.html ë‚´ë¶€

function goToReport() {
    if (!uploadedFileUrl) {
        showMessage("âŒ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
    }

    try {
        // ì „ì²´ URLì—ì„œ ë„ë©”ì¸ì„ ë–¼ê³  ê²½ë¡œ(Key)ë§Œ ì¶”ì¶œ
        const urlObj = new URL(uploadedFileUrl);
        const fileKey = urlObj.pathname.substring(1); // ì•ì˜ '/' ì œê±°

        // fileKey íŒŒë¼ë¯¸í„°ë¡œ ì´ë™
        window.location.href = `report.html?fileKey=${encodeURIComponent(fileKey)}`;
    } catch (e) {
        console.error(e);
        showMessage("âŒ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ ì‹¤íŒ¨", "error");
    }
}

    async function logout() {
        try { await fetch(`${API_BASE}/api/logout`, { method: "POST", credentials: "include" }); } catch (e) {}
        sessionStorage.clear();
        window.location.href = "index.html";
    }

    function showMessage(message, type = "info") {
        const messageBox = document.getElementById("messageBox");
        const className = type === "error" ? "error-message" : type === "success" ? "success-message" : "info-message";
        messageBox.innerHTML = `<div class="${className}">${message}</div>`;
        setTimeout(() => { messageBox.innerHTML = ""; }, 5000);
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
