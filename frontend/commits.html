<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ì¡°íšŒ</title>

    <link href="https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.3/packages/wanted-sans/dist/css/wanted-sans.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/commits.css" />

    <style>
        /* [ìˆ˜ì • 1] í°íŠ¸ ê°•ì œ ì ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        body {
            font-family: 'Wanted Sans', -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ì„ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .action-button-group {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: right; /* ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ */
            display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>GitNote - ì»¤ë°‹ ì¡°íšŒ</h1>
        <div class="user-info">
            <img id="userAvatar" src="" alt="User" />
            <span class="username" id="username"></span>
            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="messageBox"></div>

    <div class="filter-section">
        <div class="form-row">
            <div class="form-group full-width">
                <label for="repositorySelect">ë¦¬í¬ì§€í† ë¦¬</label>
                <select id="repositorySelect">
                    <option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <div id="selectedRepoInfo" style="margin-top: 8px; font-size: 12px; color: #666"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="sinceDate">ì‹œì‘ ë‚ ì§œ</label>
                <input type="date" id="sinceDate" />
            </div>
            <div class="form-group">
                <label for="untilDate">ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="date" id="untilDate" />
            </div>
        </div>

        <div class="button-group" style="margin-top: 10px;">
            <button class="btn btn-primary" id="searchBtn" onclick="searchCommits()">
                ğŸ” ì»¤ë°‹ ì¡°íšŒ
            </button>
        </div>
    </div>

    <div id="loadingBox" style="display: none">
        <div class="loading">ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <div id="commitsSection" style="display: none">
        <div class="commits-header">
            <h2>ì»¤ë°‹ ëª©ë¡</h2>
            <span class="commit-count" id="commitCount">0ê°œ</span>
        </div>

        <div id="commitsList"></div>

        <div class="action-button-group" id="actionButtons">
            <button class="btn btn-success" id="copyBtn" onclick="copyCommitsText()">
                í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>

            <button class="btn btn-aws" id="s3UploadBtn" onclick="uploadToS3()">
                â˜ï¸ ì €ì¥í•˜ê¸°
            </button>

            <button class="btn btn-report" id="generateReportBtn" onclick="goToReport()" disabled style="display: none; margin-left: 10px;">
                ğŸ“„ ë³´ê³ ì„œ ìƒì„±
            </button>
        </div>
    </div>

    <div id="emptyState" style="display: none">
        <div class="empty-state">
            <div class="empty-state-icon">-</div>
            <h3>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì„ íƒí•œ ê¸°ê°„ì— ì»¤ë°‹ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    let currentCommits = [];
    let selectedRepo = null;
    let currentCommitsText = ""; // [ì¤‘ìš”] ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    let uploadedFileUrl = "";

    async function init() {
        const username = sessionStorage.getItem("username");
        const avatar = sessionStorage.getItem("avatar");

        if (!username) {
            showMessage("âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
            setTimeout(() => { window.location.href = "index.html"; }, 2000);
            return;
        }

        document.getElementById("username").textContent = username;
        if(avatar) document.getElementById("userAvatar").src = avatar;

        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);

        document.getElementById("untilDate").value = today.toISOString().split("T")[0];
        document.getElementById("sinceDate").value = weekAgo.toISOString().split("T")[0];

        await loadRepositories();
    }

    async function loadRepositories() {
        const select = document.getElementById("repositorySelect");
        try {
            const response = await fetch(`${API_BASE}/api/github/repositories`, { credentials: "include" });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "ë¦¬í¬ì§€í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");

            select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            if (data.repositories && data.repositories.length > 0) {
                data.repositories.forEach((repo) => {
                    const fullName = repo.fullName || repo.full_name;
                    const option = document.createElement("option");
                    option.value = JSON.stringify({ owner: repo.owner || fullName.split("/")[0], name: repo.name, fullName });
                    option.textContent = fullName + (repo.isPrivate ? " (Private)" : "");
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
            }
        } catch (error) {
            select.innerHTML = '<option value="">ë¡œë“œ ì‹¤íŒ¨</option>';
            showMessage("âŒ " + error.message, "error");
        }
        select.addEventListener("change", function () {
            const info = document.getElementById("selectedRepoInfo");
            if (this.value) {
                const data = JSON.parse(this.value);
                selectedRepo = data;
                info.innerHTML = `ì„ íƒë¨: <strong>${data.fullName}</strong>`;
                info.style.color = "#28a745";
            } else {
                selectedRepo = null;
                info.innerHTML = "";
            }
        });
    }

    async function searchCommits() {
        if (!selectedRepo) { showMessage("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error"); return; }
        const since = document.getElementById("sinceDate").value;
        const until = document.getElementById("untilDate").value;

        document.getElementById("loadingBox").style.display = "block";
        document.getElementById("commitsSection").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("searchBtn").disabled = true;

        // [ì¤‘ìš”] ìƒˆ ê²€ìƒ‰ ì‹œ ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
        currentCommitsText = "";
        uploadedFileUrl = "";
        document.getElementById("generateReportBtn").style.display = "none";

        try {
            const url = `${API_BASE}/api/github/commits?owner=${encodeURIComponent(selectedRepo.owner)}&repo=${encodeURIComponent(selectedRepo.name)}&since=${since}&until=${until}&includeDetails=false`;
            const response = await fetch(url, { credentials: "include" });
            if (!response.ok) throw new Error("ì»¤ë°‹ ì¡°íšŒ ì‹¤íŒ¨");

            const data = await response.json();
            displayCommits(data.commits);

        } catch (error) {
            showMessage("âŒ " + error.message, "error");
        } finally {
            document.getElementById("loadingBox").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
        }
    }

    function displayCommits(commits) {
        if (!commits || commits.length === 0) {
            document.getElementById("emptyState").style.display = "block";
            return;
        }

        document.getElementById("commitsSection").style.display = "block";
        document.getElementById("commitCount").textContent = `${commits.length}ê°œ`;

        // í…ìŠ¤íŠ¸ ìƒì„±
        let textContent = `ë¦¬í¬ì§€í† ë¦¬: ${selectedRepo?.fullName}\n`;
        textContent += `ì¡°íšŒ ê¸°ê°„: ${document.getElementById("sinceDate").value} ~ ${document.getElementById("untilDate").value}\n`;
        textContent += `ì´ ì»¤ë°‹ ìˆ˜: ${commits.length}\n${"=".repeat(50)}\n\n`;

        commits.forEach((commit, index) => {
            const message = commit.commit?.message || "No message";
            const date = commit.commit?.author?.date || "";
            textContent += `[${index + 1}] ${date.substring(0, 10)} - ${message}\n`;
        });

        // [ìˆ˜ì • 3] ì—¬ê¸°ì„œ ì „ì—­ ë³€ìˆ˜ì— ê°’ì„ í• ë‹¹í•´ì•¼ S3 ì—…ë¡œë“œ ì‹œ "íŒŒì¼ ì—†ìŒ" ì—ëŸ¬ê°€ ì•ˆ ëœ¸
        currentCommitsText = textContent;
        console.log("Commits loaded, length:", currentCommitsText.length); // ë””ë²„ê¹…ìš©

        // í™”ë©´ ë Œë”ë§
        document.getElementById("commitsList").innerHTML = `<pre>${escapeHtml(textContent)}</pre>`;

        // [ìˆ˜ì • 4] í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ í‘œì‹œ
        document.getElementById("actionButtons").style.display = "block";
    }

    async function copyCommitsText() {
        if (!currentCommitsText) { showMessage("ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error"); return; }
        try {
            await navigator.clipboard.writeText(currentCommitsText);
            showMessage("âœ… ë³µì‚¬ ì™„ë£Œ!", "success");
        } catch (e) { showMessage("âŒ ë³µì‚¬ ì‹¤íŒ¨", "error"); }
    }

    async function uploadToS3() {
        // [ì¤‘ìš”] ë³€ìˆ˜ ì²´í¬
        if (!currentCommitsText) {
            console.error("currentCommitsText is empty!");
            showMessage("âš ï¸ ì—…ë¡œë“œí•  ì»¤ë°‹ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¡°íšŒí•´ì£¼ì„¸ìš”.", "error");
            return;
        }

        const username = sessionStorage.getItem("username");
        const s3Btn = document.getElementById("s3UploadBtn");
        s3Btn.disabled = true;
        s3Btn.innerHTML = "â˜ï¸ ì—…ë¡œë“œ ì¤‘...";

        try {
            const payload = {
                username: username,
                repositoryName: selectedRepo.fullName,
                startDate: document.getElementById("sinceDate").value,
                endDate: document.getElementById("untilDate").value,
                content: currentCommitsText // ì—¬ê¸° ê°’ì´ ë“¤ì–´ê°€ì•¼ í•¨
            };

            const response = await fetch(`${API_BASE}/api/s3/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");

            const result = await response.json();
            uploadedFileUrl = result.url;
            showMessage("âœ… ì €ì¥ ì„±ê³µ!", "success");

            // ë³´ê³ ì„œ ë²„íŠ¼ í™œì„±í™”
            const reportBtn = document.getElementById("generateReportBtn");
            reportBtn.disabled = false;
            reportBtn.style.display = "inline-block";

        } catch (error) {
            console.error(error);
            showMessage("âŒ " + error.message, "error");
        } finally {
            s3Btn.disabled = false;
            s3Btn.innerHTML = "â˜ï¸ ì €ì¥í•˜ê¸° ";
        }
    }

    function goToReport() {
        if (!uploadedFileUrl) return;
        try {
            const urlObj = new URL(uploadedFileUrl);
            window.location.href = `report.html?fileKey=${encodeURIComponent(urlObj.pathname.substring(1))}`;
        } catch (e) { showMessage("ê²½ë¡œ ì˜¤ë¥˜", "error"); }
    }

    async function logout() {
        // ë¡œê·¸ì•„ì›ƒ ë¡œì§ (ê°„ì†Œí™”)
        sessionStorage.clear();
        window.location.href = "index.html";
    }

    function showMessage(msg, type="info") {
        const box = document.getElementById("messageBox");
        box.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${msg}</div>`;
        setTimeout(() => { box.innerHTML = ""; }, 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>