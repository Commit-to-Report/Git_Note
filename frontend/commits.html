<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ì¡°íšŒ</title>

    <link href="https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.3/packages/wanted-sans/dist/css/wanted-sans.css" rel="stylesheet" />

    <link rel="stylesheet" href="css/header.css" />

    <link rel="stylesheet" href="./css/commits.css" />

    <style>
        /* ë°°ê²½ì— ê·¸ë¼ë°ì´ì…˜ íŒ¨í„´ ì¶”ê°€ */
        body {
            background: #f8f9fa;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(245, 86, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(245, 86, 0, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* [ìˆ˜ì •ë¨] ì»¨í…Œì´ë„ˆ ê°€ìš´ë° ì •ë ¬ ìŠ¤íƒ€ì¼ ì ìš© */
        .container {
            background: white;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 16px;

            /* í•µì‹¬ ìˆ˜ì • ì‚¬í•­: ê°€ìš´ë° ì •ë ¬ ë° ë„ˆë¹„ ì œí•œ */
            width: 100%;
            max-width: 1100px; /* ëŒ€ì‹œë³´ë“œì™€ ë¹„ìŠ·í•œ ë„ˆë¹„ë¡œ ì œí•œ */
            margin: 40px auto; /* ìƒí•˜ 40px ë„ìš°ê³ , ì¢Œìš°ëŠ” ìë™(ê°€ìš´ë°) ì •ë ¬ */
            padding: 30px;     /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ ë„ˆë¹„ ê³„ì‚° */
        }

        /* ë²„íŠ¼ ê·¸ë£¹ì„ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .action-button-group {
            margin-top: 28px;
            padding-top: 28px;
            border-top: 2px solid #f1f3f5;
            text-align: right;
            display: none;
            gap: 12px;
        }

        /* ê°œì„ ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - ì˜¤ë Œì§€ í¬ì¸íŠ¸ ì»¬ëŸ¬ ì ìš© */
        .btn {
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* ë²„íŠ¼ ìƒ‰ìƒ - ì˜¤ë Œì§€ ë©”ì¸ ì»¬ëŸ¬ */
        .btn-primary {
            background: #F55600;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #dc4d00;
        }

        .btn-success {
            background: #ff7d0d;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #ffa330;
        }

        .btn-aws {
            background: #ff7d0d;
            color: white;
        }
        .btn-aws:hover:not(:disabled) {
            background: #ffa330;
        }

        .btn-report {
            background: #ff7d0d;
            color: white;
        }
        .btn-report:hover:not(:disabled) {
            background: #ffa330;
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 24px;
            border-radius: 12px;
        }

        /* ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ì˜¤ë Œì§€ ê°•ì¡° */
        select:focus,
        input[type="date"]:focus {
            border-color: #F55600 !important;
            box-shadow: 0 0 0 3px rgba(245, 86, 0, 0.1) !important;
        }

        /* ì»¤ë°‹ í—¤ë” */
        .commits-header {
            border-left-color: #F55600 !important;
        }

        .commit-count {
            background: #fff5f0;
            color: #F55600;
            border: 1px solid #ffe0cc;
        }

        /* ì»¤ë°‹ ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ */
        #commitsList pre {
            background: #f8f9fa !important;
            color: #212529 !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
        }

        /* Empty State */
        .empty-state {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
        }

        /* ë¡œë”© ë°•ìŠ¤ */
        .loading {
            background: white;
            padding: 24px 48px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: inline-block;
            color: #495057;
        }

        #loadingBox {
            text-align: center;
        }

        /* ì„ íƒëœ ë¦¬í¬ì§€í† ë¦¬ ì •ë³´ ìŠ¤íƒ€ì¼ ê°œì„  */
        #selectedRepoInfo {
            background: #fff5f0;
            border: 1px solid #ffe0cc;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ ì˜¤ë Œì§€ í…Œë§ˆ */
        .success-message {
            background: #fff5f0 !important;
            color: #F55600 !important;
            border: 1px solid #ffe0cc !important;
        }

        .error-message {
            background: #fff5f5 !important;
            color: #dc2626 !important;
            border: 1px solid #fecaca !important;
        }
    </style>
</head>
<body>
<div id="header-container"></div>

<div class="container">
    <div id="messageBox"></div>

    <div class="filter-section">
        <div class="form-row">
            <div class="form-group full-width">
                <label for="repositorySelect">ë¦¬í¬ì§€í† ë¦¬</label>
                <select id="repositorySelect">
                    <option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <div id="selectedRepoInfo" style="margin-top: 8px; font-size: 12px; color: #666"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="sinceDate">ì‹œì‘ ë‚ ì§œ</label>
                <input type="date" id="sinceDate" />
            </div>
            <div class="form-group">
                <label for="untilDate">ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="date" id="untilDate" />
            </div>
        </div>

        <div class="button-group" style="margin-top: 10px;">
            <button class="btn btn-primary" id="searchBtn" onclick="searchCommits()">
                ğŸ” ì»¤ë°‹ ì¡°íšŒ
            </button>
        </div>
    </div>

    <div id="loadingBox" style="display: none">
        <div class="loading">ì»¤ë°‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <div id="commitsSection" style="display: none">
        <div class="commits-header">
            <h2>ì»¤ë°‹ ëª©ë¡</h2>
            <span class="commit-count" id="commitCount">0ê°œ</span>
        </div>

        <div id="commitsList"></div>

        <div class="action-button-group" id="actionButtons">
            <button class="btn btn-success" id="copyBtn" onclick="copyCommitsText()">
                í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>

            <button class="btn btn-aws" id="s3UploadBtn" onclick="uploadToS3()">
                â˜ï¸ ì €ì¥í•˜ê¸°
            </button>

            <button class="btn btn-report" id="generateReportBtn" onclick="goToReport()" disabled style="display: none; margin-left: 10px;">
                ğŸ“„ ë³´ê³ ì„œ ìƒì„±
            </button>
        </div>
    </div>

    <div id="emptyState" style="display: none">
        <div class="empty-state">
            <div class="empty-state-icon">-</div>
            <h3>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì„ íƒí•œ ê¸°ê°„ì— ì»¤ë°‹ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    let currentCommits = [];
    let selectedRepo = null;
    let currentCommitsText = "";
    let uploadedFileUrl = "";

    async function init() {
        const username = sessionStorage.getItem("username");

        if (!username) {
            showMessage("âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
            setTimeout(() => { window.location.href = "index.html"; }, 2000);
            return;
        }

        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);

        document.getElementById("untilDate").value = today.toISOString().split("T")[0];
        document.getElementById("sinceDate").value = weekAgo.toISOString().split("T")[0];

        await loadRepositories();
    }

    async function loadRepositories() {
        const select = document.getElementById("repositorySelect");
        try {
            const response = await fetch(`${API_BASE}/api/github/repositories`, { credentials: "include" });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "ë¦¬í¬ì§€í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");

            select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            if (data.repositories && data.repositories.length > 0) {
                data.repositories.forEach((repo) => {
                    const fullName = repo.fullName || repo.full_name;
                    const option = document.createElement("option");
                    option.value = JSON.stringify({ owner: repo.owner || fullName.split("/")[0], name: repo.name, fullName });
                    option.textContent = fullName + (repo.isPrivate ? " (Private)" : "");
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
            }
        } catch (error) {
            select.innerHTML = '<option value="">ë¡œë“œ ì‹¤íŒ¨</option>';
            showMessage("âŒ " + error.message, "error");
        }
        select.addEventListener("change", function () {
            const info = document.getElementById("selectedRepoInfo");
            if (this.value) {
                const data = JSON.parse(this.value);
                selectedRepo = data;
                info.innerHTML = `ì„ íƒë¨: <strong>${data.fullName}</strong>`;
                info.style.color = "#28a745";
            } else {
                selectedRepo = null;
                info.innerHTML = "";
            }
        });
    }

    async function searchCommits() {
        if (!selectedRepo) { showMessage("âš ï¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error"); return; }
        const since = document.getElementById("sinceDate").value;
        const until = document.getElementById("untilDate").value;

        document.getElementById("loadingBox").style.display = "block";
        document.getElementById("commitsSection").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("searchBtn").disabled = true;

        currentCommitsText = "";
        uploadedFileUrl = "";
        document.getElementById("generateReportBtn").style.display = "none";

        try {
            const url = `${API_BASE}/api/github/commits?owner=${encodeURIComponent(selectedRepo.owner)}&repo=${encodeURIComponent(selectedRepo.name)}&since=${since}&until=${until}&includeDetails=false`;
            const response = await fetch(url, { credentials: "include" });
            if (!response.ok) throw new Error("ì»¤ë°‹ ì¡°íšŒ ì‹¤íŒ¨");

            const data = await response.json();
            displayCommits(data.commits);

        } catch (error) {
            showMessage("âŒ " + error.message, "error");
        } finally {
            document.getElementById("loadingBox").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
        }
    }

    function displayCommits(commits) {
        if (!commits || commits.length === 0) {
            document.getElementById("emptyState").style.display = "block";
            return;
        }

        document.getElementById("commitsSection").style.display = "block";
        document.getElementById("commitCount").textContent = `${commits.length}ê°œ`;

        let textContent = `ë¦¬í¬ì§€í† ë¦¬: ${selectedRepo?.fullName}\n`;
        textContent += `ì¡°íšŒ ê¸°ê°„: ${document.getElementById("sinceDate").value} ~ ${document.getElementById("untilDate").value}\n`;
        textContent += `ì´ ì»¤ë°‹ ìˆ˜: ${commits.length}\n${"=".repeat(50)}\n\n`;

        commits.forEach((commit, index) => {
            const message = commit.commit?.message || "No message";
            const date = commit.commit?.author?.date || "";
            textContent += `[${index + 1}] ${date.substring(0, 10)} - ${message}\n`;
        });

        currentCommitsText = textContent;

        document.getElementById("commitsList").innerHTML = `<pre>${escapeHtml(textContent)}</pre>`;
        document.getElementById("actionButtons").style.display = "block";
    }

    async function copyCommitsText() {
        if (!currentCommitsText) { showMessage("ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error"); return; }
        try {
            await navigator.clipboard.writeText(currentCommitsText);
            showMessage("âœ… ë³µì‚¬ ì™„ë£Œ!", "success");
        } catch (e) { showMessage("âŒ ë³µì‚¬ ì‹¤íŒ¨", "error"); }
    }

    async function uploadToS3() {
        if (!currentCommitsText) {
            showMessage("âš ï¸ ì—…ë¡œë“œí•  ì»¤ë°‹ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¡°íšŒí•´ì£¼ì„¸ìš”.", "error");
            return;
        }

        const username = sessionStorage.getItem("username");
        const s3Btn = document.getElementById("s3UploadBtn");
        s3Btn.disabled = true;
        s3Btn.innerHTML = "â˜ï¸ ì—…ë¡œë“œ ì¤‘...";

        try {
            const payload = {
                username: username,
                repositoryName: selectedRepo.fullName,
                startDate: document.getElementById("sinceDate").value,
                endDate: document.getElementById("untilDate").value,
                content: currentCommitsText
            };

            const response = await fetch(`${API_BASE}/api/s3/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");

            const result = await response.json();
            uploadedFileUrl = result.url;
            showMessage("âœ… ì €ì¥ ì„±ê³µ!", "success");

            const reportBtn = document.getElementById("generateReportBtn");
            reportBtn.disabled = false;
            reportBtn.style.display = "inline-block";

        } catch (error) {
            console.error(error);
            showMessage("âŒ " + error.message, "error");
        } finally {
            s3Btn.disabled = false;
            s3Btn.innerHTML = "â˜ï¸ ì €ì¥í•˜ê¸° ";
        }
    }

    function goToReport() {
        if (!uploadedFileUrl) return;
        try {
            const urlObj = new URL(uploadedFileUrl);
            window.location.href = `report.html?fileKey=${encodeURIComponent(urlObj.pathname.substring(1))}`;
        } catch (e) { showMessage("ê²½ë¡œ ì˜¤ë¥˜", "error"); }
    }

    function showMessage(msg, type="info") {
        const box = document.getElementById("messageBox");
        box.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${msg}</div>`;
        setTimeout(() => { box.innerHTML = ""; }, 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    window.addEventListener("DOMContentLoaded", init);
</script>

<script src="./js/header.js"></script>
</body>
</html>