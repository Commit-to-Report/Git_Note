<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitNote - ì»¤ë°‹ ëª©ë¡</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/footer.css" />
    <style>
        @import url("https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.3/packages/wanted-sans/dist/css/wanted-sans.css");

        * {
          font-family: "Wanted Sans Variable", "Wanted Sans", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
        }

        body {
          background-color: #fafafa;
        }

        main {
          padding: 20px;
        }

        .list-container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border: 1px solid #e0e0e0;
          border-radius: 16px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          overflow: hidden;
        }

        .list-header {
          padding: 28px 32px;
          background: white;
          color: #111827;
          border-bottom: 1px solid #f0f0f0;
        }

        .list-header h2 {
          margin: 0;
          font-size: 22px;
          font-weight: 700;
          color: #212121;
          letter-spacing: -0.5px;
        }

        .commit-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        .commit-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 24px 32px;
          border-bottom: 1px solid #f5f5f5;
          transition: background-color 0.2s;
          cursor: pointer;
        }

        .commit-item:last-child {
          border-bottom: none;
        }

        .commit-item:hover {
          background-color: #fafafa;
        }

        .item-info {
          display: flex;
          flex-direction: column;
          gap: 8px;
          flex: 1;
        }

        .file-name {
          font-weight: 600;
          font-size: 16px;
          color: #212121;
        }

        .file-date {
          font-size: 13px;
          color: #9e9e9e;
          font-weight: 400;
        }

        .btn-report {
          padding: 10px 24px;
          background: #f55600;
          border: none;
          border-radius: 8px;
          color: white;
          font-size: 14px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-report:hover {
          background: #d94d00;
          transform: translateY(-1px);
        }

        .modal-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background: white;
          width: 90%;
          max-width: 800px;
          border-radius: 16px;
          padding: 0;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
          position: relative;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 24px 28px;
          background: white;
          border-bottom: 1px solid #f0f0f0;
        }

        .modal-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 700;
          color: #212121;
        }

        .close-btn {
          background: #f5f5f5;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #757575;
          width: 36px;
          height: 36px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .close-btn:hover {
          background: #e0e0e0;
          color: #424242;
        }

        .modal-body {
          overflow-y: auto;
          background: #fafafa;
          padding: 20px;
          margin: 20px 28px;
          border-radius: 8px;
          font-family: "Consolas", "Monaco", "Courier New", monospace !important;
          white-space: pre-wrap;
          font-size: 13px;
          line-height: 1.6;
          color: #212121;
          border: 1px solid #e0e0e0;
          flex: 1;
        }

        .modal-footer {
          padding: 20px 28px;
          text-align: right;
          border-top: 1px solid #f0f0f0;
        }

        #modalReportBtn {
          padding: 12px 28px;
          background: #f55600;
          border: none;
          border-radius: 8px;
          color: white;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.2s;
        }

        #modalReportBtn:hover {
          background: #d94d00;
          transform: translateY(-1px);
        }

        .empty-message {
          text-align: center;
          padding: 60px 20px;
          color: #9e9e9e;
          font-size: 15px;
          font-weight: 500;
        }

        /* =========================================
           ğŸŒ™ ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼
           ========================================= */
        body.dark-mode {
            background-color: #121212 !important;
            color: #e0e0e0;
        }
        body.dark-mode .list-container {
            background: #1e1e1e;
            border-color: #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        body.dark-mode .list-header {
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            color: #fff;
        }
        body.dark-mode .list-header h2 {
            color: #fff;
        }
        body.dark-mode .commit-item {
            border-bottom: 1px solid #333;
        }
        body.dark-mode .commit-item:hover {
            background-color: #2c2c2c;
        }
        body.dark-mode .file-name {
            color: #fff;
        }
        body.dark-mode .file-date {
            color: #aaa;
        }
        body.dark-mode .modal-content {
            background: #1e1e1e;
            border: 1px solid #444;
        }
        body.dark-mode .modal-header {
            background: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        body.dark-mode .modal-header h3 {
            color: #fff;
        }
        body.dark-mode .modal-body {
            background: #252525;
            color: #ddd;
            border: 1px solid #333;
        }
        body.dark-mode .modal-footer {
            border-top: 1px solid #333;
        }
        body.dark-mode .close-btn {
            background: #333;
            color: #fff;
        }
        body.dark-mode .close-btn:hover {
            background: #444;
        }
    </style>
</head>
<body>
<div id="header-container"></div>

<main>
    <div class="list-container">
        <div class="list-header">
            <h2>ğŸ“‚ ë‚˜ì˜ ì»¤ë°‹ ëª©ë¡</h2>
        </div>

        <ul id="fileList" class="commit-list">
            <li class="empty-message">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
        </ul>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">íŒŒì¼ ì œëª©</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <pre id="modalBody" class="modal-body">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre>

            <div class="modal-footer">
                <button id="modalReportBtn" class="btn-report">
                    âœ¨ë³´ê³ ì„œ ìƒì„±
                </button>
            </div>
        </div>
    </div>
</main>

<div id="footer-container"></div>

<script src="js/config.js"></script>
<script src="js/header.js"></script>
<script src="js/footer.js"></script>
<script>
    const API_BASE = window.API_BASE_URL;

    document.addEventListener("DOMContentLoaded", async () => {
      const username = sessionStorage.getItem("username");

      if (!username) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }

      loadFileList(username);
    });

    // [ì¶”ê°€] ìš©ëŸ‰(Byte)ì„ ì½ê¸° ì‰½ê²Œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (KB, MB)
    function formatBytes(bytes, decimals = 1) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
    }

    // [ì¶”ê°€] ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (ì˜ˆ: 25. 12. 01. 14:30)
    function formatDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const year = String(date.getFullYear()).slice(-2);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${year}. ${month}. ${day}. ${hour}:${min}`;
    }

async function loadFileList(username) {
      const listElement = document.getElementById("fileList");

      try {
        const response = await fetch(
          `${API_BASE}/api/s3/list?username=${username}`
        );
        if (!response.ok) throw new Error("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");

        const data = await response.json();
        const files = data.files;

        listElement.innerHTML = "";

        if (!files || files.length === 0) {
          listElement.innerHTML =
            '<li class="empty-message">ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
          return;
        }

        files.forEach((file) => {
          const fileName = file.fileName;
          const fileKey = file.key;
          const fileUrl = file.url;

          // [ìˆ˜ì • 1] ë°±ì—”ë“œì—ì„œ ë°›ì€ sizeì™€ lastModifiedë¥¼ í¬ë§·íŒ… í•¨ìˆ˜ë¡œ ë³€í™˜
          // (ë°±ì—”ë“œì—ì„œ ì´ í•„ë“œë“¤ì„ ì•ˆ ë³´ë‚´ì£¼ë©´ 0 ë˜ëŠ” 'ì •ë³´ ì—†ìŒ'ìœ¼ë¡œ ì²˜ë¦¬)
          const fileSizeStr = file.size ? formatBytes(file.size) : '0 B';
          const fileDateStr = file.lastModified ? formatDate(file.lastModified) : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

          const li = document.createElement("li");
          li.className = "commit-item";

          const infoDiv = document.createElement("div");
          infoDiv.className = "item-info";

          // [ìˆ˜ì • 2] ì—¬ê¸°ê°€ í•µì‹¬! S3 Key ëŒ€ì‹  ë‚ ì§œì™€ ìš©ëŸ‰ì„ ë³´ì—¬ì£¼ë„ë¡ ë³€ê²½
          infoDiv.innerHTML = `
              <span class="file-name">ğŸ“„ ${fileName}</span>
              <span class="file-date" style="display:flex; gap:10px; align-items:center; margin-top:4px;">
                  <span>ğŸ•’ ${fileDateStr}</span>
                  <span style="color:#ddd;">|</span>
                  <span>ğŸ’¾ ${fileSizeStr}</span>
              </span>
          `;

          const btn = document.createElement("button");
          btn.className = "btn-report";
          btn.textContent = "ë³´ê³ ì„œ ìƒì„±";

          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = `report.html?fileKey=${encodeURIComponent(
              fileKey
            )}`;
          });

          li.addEventListener("click", () => {
            openModal(file);
          });

          li.appendChild(infoDiv);
          li.appendChild(btn);
          listElement.appendChild(li);
        });
      } catch (error) {
        console.error(error);
        listElement.innerHTML =
          '<li class="empty-message" style="color:#ef4444">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
      }
    }

    function goToReportPage(fileKey) {
      window.location.href = `report.html?fileKey=${encodeURIComponent(
        fileKey
      )}`;
    }

    // file ê°ì²´ë¥¼ í†µì§¸ë¡œ ë°›ìŒ
    function openModal(file) {
      const modal = document.getElementById("detailModal");
      const title = document.getElementById("modalTitle");
      const body = document.getElementById("modalBody");
      const reportBtn = document.getElementById("modalReportBtn");

      title.textContent = file.fileName;
      modal.style.display = "flex";

      // ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ì—ëŠ” key ì—°ê²°
      reportBtn.onclick = () => goToReportPage(file.key);

      body.textContent = "ë¡œë”© ì¤‘...";

      // [ìˆ˜ì •ë¨] ë°±ì—”ë“œê°€ ì¤€ í”„ë¦¬ì‚¬ì¸ URLì„ ë°”ë¡œ ì‚¬ìš©! (ì£¼ì†Œ ì¡°ë¦½ X)
      fetch(file.url)
        .then((res) => {
          if (!res.ok) throw new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (403/404)");
          return res.text();
        })
        .then((text) => {
          body.textContent = text;
        })
        .catch((err) => {
          body.textContent =
            "âš ï¸ íŒŒì¼ ë‚´ìš©ì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" + err.message;
        });
    }

    function closeModal() {
      document.getElementById("detailModal").style.display = "none";
    }


    window.onclick = function (event) {
      const modal = document.getElementById("detailModal");
      if (event.target == modal) {
        closeModal();
      }
    };

    // [ë‹¤í¬ëª¨ë“œ ì‹¤í–‰ í•¨ìˆ˜]
    function checkDarkMode() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }

    // í˜ì´ì§€ ì¼œì§€ìë§ˆì ì‹¤í–‰
    checkDarkMode();

    // 0.1ì´ˆë§ˆë‹¤ ê°ì§€ (í—¤ë” ë²„íŠ¼ ë°˜ì‘ìš©)
    setInterval(checkDarkMode, 100);

</script>
</body>
</html>